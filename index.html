<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;">
    <title>Co-Watch | Final Fixes</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* CORE & FX */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; scrollbar-width: none; outline: none; }
        ::-webkit-scrollbar { display: none; }
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #050505; font-family: 'Manrope', sans-serif; color: #fff; }

        .noise-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; opacity: 0.03; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E"); }
        
        /* GLASS UI */
        .glass-panel { 
            background: rgba(18, 18, 18, 0.85); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08); 
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
        }
        
        .glass-btn { 
            background: rgba(255,255,255,0.05); 
            border: 1px solid rgba(255,255,255,0.05); 
            transition: all 0.2s ease; 
            cursor: pointer; 
        }
        .glass-btn:hover { background: rgba(255,255,255,0.15); transform: translateY(-1px); }
        .glass-btn:active { transform: translateY(1px); }
        .glass-btn.disabled { opacity: 0.5; pointer-events: none; }

        .sidebar-item { transition: 0.2s; border-radius: 12px; }
        .sidebar-item:hover { background: rgba(255,255,255,0.05); }

        /* PLAYERS & LAYOUT */
        #video-layer { position: fixed; inset: 0; z-index: 5; background: #000; display: flex; justify-content: center; align-items: center; }
        #player-yt, #player-vk-container, #player-stream { width: 100%; height: 100%; position: absolute; inset: 0; }
        iframe { width: 100% !important; height: 100% !important; border: none; pointer-events: auto; }
        
        /* UI LAYERS */
        #ui-layer { 
            position: fixed; inset: 0; z-index: 50; 
            pointer-events: none; 
            display: flex; flex-direction: column; justify-content: space-between; padding: 20px; 
            transition: opacity 0.3s ease; 
        }
        #top-bar, #bottom-bar, #sidebar, #chat-toggle-container { pointer-events: auto; }
        
        /* SIDEBAR (CHAT) */
        #sidebar {
            position: fixed; right: 20px; top: 80px; bottom: 100px; width: 320px;
            z-index: 60; 
            transform: translateX(120%); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; flex-direction: column;
        }
        #sidebar.active { transform: translateX(0); }
        
        .chat-msg { animation: fadeIn 0.3s ease; margin-bottom: 8px; font-size: 13px; line-height: 1.4; word-break: break-word; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* CONTROLS */
        .seek-slider { -webkit-appearance: none; width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; outline: none; cursor: pointer; position: relative; }
        .seek-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; border-radius: 50%; background: #fff; cursor: pointer; box-shadow: 0 0 10px rgba(255,255,255,0.5); transition: transform 0.1s; }
        .seek-slider:hover::-webkit-slider-thumb { transform: scale(1.3); }

        /* NOTIFICATION TOAST (FIXED VISIBILITY) */
        #notification-area {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 9999; /* Max Z-Index */
            pointer-events: none; width: 90%; max-width: 400px;
            display: flex; flex-direction: column; gap: 10px; align-items: center;
        }
        .toast {
            background: #111; /* Solid dark background */
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            opacity: 0; 
            transform: translateY(-20px);
            animation: slideInToast 0.5s cubic-bezier(0.22, 1, 0.36, 1) forwards;
        }
        .toast.hiding { animation: fadeOutToast 0.5s ease forwards; }
        @keyframes slideInToast { 
            0% { opacity: 0; transform: translateY(-20px) scale(0.9); }
            100% { opacity: 1; transform: translateY(0) scale(1); } 
        }
        @keyframes fadeOutToast { 
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0.9); } 
        }

        /* ADMIN BADGE */
        .admin-crown { color: #fbbf24; text-shadow: 0 0 10px rgba(251, 191, 36, 0.5); }
        
        /* UTILS */
        .force-hidden { display: none !important; }
        
        /* Native Mode Overlay */
        #native-mode-hint { 
            position: fixed; top: 80px; left: 50%; transform: translateX(-50%); 
            background: #ef4444; color: white;
            padding: 10px 24px; border-radius: 30px; 
            font-weight: 800; font-size: 13px; text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.4);
            pointer-events: auto !important; 
            cursor: pointer;
            opacity: 0; transition: 0.3s; z-index: 100; 
        }
        #click-overlay { position: absolute; inset: 0; z-index: 20; cursor: default; display: block; }
    </style>
</head>
<body onclick="unlockAudio()">

    <div class="noise-bg"></div>
    
    <div id="notification-area"></div>

    <div id="native-mode-hint" onclick="toggleNativeMode()">
        <i class="fa-solid fa-rotate-left mr-2"></i> Вернуть интерфейс
    </div>

    <div id="screen-auth" class="fixed inset-0 z-[100] flex items-center justify-center bg-[#050505] transition-opacity duration-500">
        <div class="glass-panel p-10 rounded-[32px] max-w-sm w-full text-center pointer-events-auto relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500"></div>
            <h1 class="text-5xl font-extrabold mb-2 tracking-tighter">Co-Watch</h1>
            <p class="text-gray-400 mb-8 text-sm font-mono uppercase tracking-widest">Fixed Edition</p>
            
            <button id="btn-google-login" class="w-full bg-white text-black font-bold py-4 rounded-xl mb-3 hover:bg-gray-200 transition">
                <i class="fa-brands fa-google mr-2"></i> Войти
            </button>
            <button id="btn-guest-login" class="w-full glass-btn py-4 rounded-xl text-sm font-semibold">
                Гость
            </button>
        </div>
    </div>

    <div id="screen-lobby" class="fixed inset-0 z-[90] flex items-center justify-center bg-[#050505] force-hidden pointer-events-auto">
        <div class="w-full max-w-5xl p-6 flex flex-col md:flex-row gap-6 h-[70vh]">
            <div class="w-full md:w-1/3 glass-panel rounded-3xl p-8 flex flex-col items-center justify-center relative">
                <img id="lobby-avatar" class="w-32 h-32 rounded-full mb-6 object-cover border-4 border-white/10 shadow-2xl">
                <h2 class="text-2xl font-bold mb-2"><span id="lobby-username">Guest</span></h2>
                <button id="btn-logout" class="text-xs text-red-400 hover:text-red-300 border border-red-500/20 px-4 py-2 rounded-full transition">Выйти</button>
            </div>
            
            <div class="w-full md:w-2/3 glass-panel rounded-3xl p-10 flex flex-col justify-center space-y-6 relative overflow-hidden">
                <div class="absolute -right-20 -top-20 w-64 h-64 bg-purple-600/20 rounded-full blur-[100px]"></div>
                <h3 class="text-3xl font-bold mb-2">Кинозал</h3>
                <button id="btn-create-room" class="w-full bg-white text-black py-5 rounded-2xl font-bold text-lg hover:scale-[1.01] transition shadow-[0_0_30px_rgba(255,255,255,0.2)]">
                    <i class="fa-solid fa-plus mr-2"></i> Создать комнату
                </button>
                <div class="flex gap-3 pt-4 border-t border-white/10">
                    <input id="input-room-id" placeholder="ID комнаты..." class="flex-1 bg-black/30 border border-white/10 rounded-2xl px-6 text-lg font-mono outline-none focus:border-white/40 transition">
                    <button id="btn-join-room" class="glass-btn px-8 rounded-2xl font-bold text-lg hover:bg-white hover:text-black">GO</button>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-app" class="fixed inset-0 bg-black force-hidden">
        
        <div id="video-layer">
            <div id="player-placeholder" class="flex flex-col items-center justify-center">
                <div class="w-24 h-24 rounded-full border border-white/10 flex items-center justify-center mb-6 animate-pulse">
                    <i class="fa-solid fa-film text-4xl text-white/30"></i>
                </div>
                <p class="text-white/30 font-mono tracking-[0.2em] text-sm">ВСТАВЬ ССЫЛКУ</p>
            </div>
            <div id="player-yt" class="force-hidden z-10"></div>
            <div id="player-vk-container" class="force-hidden z-10"></div>
            <video id="player-stream" class="force-hidden z-10 object-contain" autoplay playsinline></video>
            
            <div id="click-overlay" class="absolute inset-0 z-20 cursor-default" style="display:block;"></div>
        </div>

        <div id="ui-layer">
            <div id="top-bar" class="flex justify-between items-center transition-ui opacity-100">
                <div class="glass-panel pl-2 pr-5 py-2 rounded-full flex gap-3 items-center cursor-pointer hover:bg-white/5 transition" id="copy-room-id">
                    <div class="w-8 h-8 bg-green-500/20 rounded-full flex items-center justify-center text-green-400">
                        <i class="fa-solid fa-link text-xs"></i>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-[10px] text-white/40 font-bold uppercase">Room ID</span>
                        <span id="display-room-id" class="font-mono font-bold leading-none tracking-wider">...</span>
                    </div>
                </div>

                <div class="glass-panel p-1.5 rounded-full flex gap-2 w-full max-w-lg mx-4 shadow-lg">
                    <input id="input-video-url" placeholder="YouTube / VK / Direct Link..." class="bg-transparent flex-1 px-4 outline-none text-sm text-white font-medium placeholder-white/20">
                    <button id="btn-load-video" class="w-9 h-9 bg-white text-black rounded-full flex items-center justify-center hover:scale-105 transition"><i class="fa-solid fa-play ml-0.5 text-xs"></i></button>
                </div>

                <div class="flex gap-3">
                    <button id="btn-leave-room" class="glass-panel w-10 h-10 rounded-full flex items-center justify-center text-red-400 hover:bg-red-500/10"><i class="fa-solid fa-right-from-bracket"></i></button>
                </div>
            </div>

            <div id="sidebar" class="glass-panel rounded-3xl overflow-hidden flex flex-col">
                <div class="flex border-b border-white/5">
                    <button id="tab-chat" class="flex-1 py-3 text-xs font-bold uppercase tracking-wider bg-white/5">Чат</button>
                    <button id="tab-users" class="flex-1 py-3 text-xs font-bold uppercase tracking-wider text-white/40 hover:text-white">Люди</button>
                </div>
                
                <div id="view-chat" class="flex-1 flex flex-col min-h-0">
                    <div id="chat-messages" class="flex-1 overflow-y-auto p-4 flex flex-col gap-2"></div>
                    <div class="p-3 border-t border-white/5 bg-black/20">
                        <form id="form-chat" class="flex gap-2">
                            <input id="input-chat" class="flex-1 bg-white/5 rounded-xl px-3 py-2 text-sm outline-none focus:bg-white/10 transition" placeholder="Сообщение..." autocomplete="off">
                            <button type="submit" class="w-9 h-9 bg-white/10 rounded-xl flex items-center justify-center hover:bg-white hover:text-black transition"><i class="fa-solid fa-paper-plane text-xs"></i></button>
                        </form>
                    </div>
                </div>

                <div id="view-users" class="flex-1 overflow-y-auto p-2 hidden">
                    <div id="list-users" class="flex flex-col gap-1"></div>
                </div>
            </div>
            
            <button id="btn-toggle-sidebar" class="fixed bottom-8 right-8 z-[70] glass-panel w-14 h-14 rounded-2xl flex items-center justify-center text-white/70 hover:text-white hover:bg-white/10 transition shadow-2xl">
                <i class="fa-solid fa-user-group text-xl"></i>
                <span id="badge-users" class="absolute top-3 right-3 w-3 h-3 bg-red-500 rounded-full border-2 border-[#121212] hidden animate-bounce"></span>
            </button>

            <div id="bottom-bar" class="flex flex-col gap-4 transition-ui w-full max-w-2xl mx-auto pb-6 opacity-100">
                <div id="timeline-container" class="glass-panel px-5 py-3 rounded-2xl flex items-center gap-4">
                     <button id="btn-play-pause" class="w-6 text-white/80 hover:text-white transition" onclick="togglePlay()"><i class="fa-solid fa-play"></i></button>
                     <span id="time-current" class="text-xs font-mono text-white/50 w-10 text-right">0:00</span>
                     <input type="range" id="seek-bar" class="seek-slider flex-1" min="0" max="100" value="0">
                     <span id="time-duration" class="text-xs font-mono text-white/50 w-10">0:00</span>
                </div>
                
                <div class="glass-panel p-2 rounded-2xl flex justify-center gap-4 items-center">
                    <button id="btn-toggle-voice" class="glass-btn w-12 h-12 rounded-xl flex items-center justify-center text-xl text-white/30" title="Голос"><i class="fa-solid fa-microphone-slash"></i></button>
                    <button id="btn-screen-share" class="glass-btn w-12 h-12 rounded-xl flex items-center justify-center text-xl text-purple-400 hover:text-purple-300 hover:bg-purple-500/10" title="Демонстрация экрана"><i class="fa-solid fa-desktop"></i></button>
                    
                    <div class="flex flex-col items-center px-4">
                        <span class="text-[10px] text-white/30 uppercase tracking-widest font-bold">Status</span>
                        <div class="flex items-center gap-2">
                            <div id="status-dot" class="w-2 h-2 bg-green-500 rounded-full shadow-[0_0_10px_#22c55e]"></div>
                            <span id="status-text" class="text-xs font-bold text-green-400">READY</span>
                        </div>
                    </div>

                    <button id="btn-native" class="glass-btn w-12 h-12 rounded-xl flex items-center justify-center text-xl text-white/50 hover:text-white" onclick="toggleNativeMode()" title="Режим Native (Настройки YT)"><i class="fa-solid fa-gear"></i></button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInAnonymously, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, serverTimestamp, addDoc, query, orderBy, limit, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = { apiKey: "AIzaSyBrm8hgy9LGFFL_7CdlnR6jxyolqy94AQA", authDomain: "upbeat-orb-479013-p8.firebaseapp.com", projectId: "upbeat-orb-479013-p8", storageBucket: "upbeat-orb-479013-p8.firebasestorage.app", messagingSenderId: "547138498300", appId: "1:547138498300:web:a03c11d6aafd5f027cf179" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const APP_ID = 'cw-admin-fix-v2';

        const get = (id) => document.getElementById(id);
        const formatTime = (s) => { const m=Math.floor(s/60), sec=Math.floor(s%60); return `${m}:${sec<10?'0':''}${sec}`; };
        window.unlockAudio = () => { const a = new (window.AudioContext || window.webkitAudioContext)(); if(a.state==='suspended') a.resume(); };

        // --- UX: NOTIFICATIONS (FIXED) ---
        window.showNotification = (text) => {
            const area = get('notification-area');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = text;
            area.appendChild(toast);
            
            // 20 секунд висит, потом исчезает
            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 500); // время на анимацию исчезновения
            }, 20000); 
        };

        // --- AUTH ---
        onAuthStateChanged(auth, u => {
            if(u) {
                get('lobby-username').textContent = u.displayName || 'Guest';
                const seed = u.uid;
                get('lobby-avatar').src = u.photoURL || `https://api.dicebear.com/7.x/adventurer/svg?seed=${seed}&backgroundColor=b6e3f4,c0aede,d1d4f9`;
                get('screen-auth').classList.add('force-hidden');
                get('screen-lobby').classList.remove('force-hidden');
            } else {
                get('screen-auth').classList.remove('force-hidden');
                get('screen-lobby').classList.add('force-hidden');
                get('screen-app').classList.add('force-hidden');
            }
        });

        get('btn-google-login').onclick = () => signInWithPopup(auth, new GoogleAuthProvider()).catch(e => alert(e.message));
        get('btn-guest-login').onclick = () => signInAnonymously(auth).then(c => updateProfile(c.user, { displayName: `Watcher ${Math.floor(Math.random()*100)}` }));
        get('btn-logout').onclick = () => signOut(auth);

        // --- ROOMS & ADMIN SYSTEM ---
        let currentRoomId = null;
        let currentUser = null;
        let myRole = 'viewer'; 
        let iAmMuted = false;
        
        get('btn-create-room').onclick = () => { const id = Math.random().toString(36).substring(2,7).toUpperCase(); joinRoom(id, true); };
        get('btn-join-room').onclick = () => { const id = get('input-room-id').value.trim().toUpperCase(); if(id) joinRoom(id); };
        
        get('copy-room-id').onclick = () => {
             navigator.clipboard.writeText(currentRoomId);
             showNotification(`ID комнаты ${currentRoomId} скопирован!`);
        };

        async function joinRoom(id, isCreator = false) {
            currentRoomId = id;
            currentUser = auth.currentUser;
            get('display-room-id').textContent = id;
            
            const userRef = doc(db, 'artifacts', APP_ID, 'rooms', id, 'presence', currentUser.uid);
            await setDoc(userRef, {
                uid: currentUser.uid, 
                displayName: currentUser.displayName, 
                photoURL: currentUser.photoURL || `https://api.dicebear.com/7.x/adventurer/svg?seed=${currentUser.uid}&backgroundColor=b6e3f4,c0aede,d1d4f9`,
                role: isCreator ? 'admin' : 'viewer',
                joinedAt: serverTimestamp(), 
                lastActive: serverTimestamp(),
                mutedByAdmin: false
            });

            onSnapshot(doc(db, 'artifacts', APP_ID, 'rooms', id), s => { if(s.exists()) syncState(s.data()); });
            
            const chatQ = query(collection(db, 'artifacts', APP_ID, 'rooms', id, 'messages'), orderBy('createdAt', 'asc'), limit(50));
            onSnapshot(chatQ, snapshot => {
                const div = get('chat-messages');
                div.innerHTML = '';
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const el = document.createElement('div');
                    el.className = 'chat-msg flex flex-col';
                    el.innerHTML = `<span class="text-[10px] font-bold text-white/50 mb-0.5">${msg.user}</span><span class="bg-white/10 p-2 rounded-xl rounded-tl-none self-start">${msg.text}</span>`;
                    if(msg.uid === currentUser.uid) {
                        el.innerHTML = `<span class="bg-blue-500/20 p-2 rounded-xl rounded-tr-none self-end">${msg.text}</span>`;
                    }
                    div.appendChild(el);
                });
                div.scrollTop = div.scrollHeight;
                
                // Show badge if chat is closed and new messages arrive
                if(!get('sidebar').classList.contains('active')) {
                    // Logic to show badge (simple implementation: show on any update if closed)
                }
            });

            onSnapshot(collection(db, 'artifacts', APP_ID, 'rooms', id, 'presence'), snapshot => {
                const list = get('list-users');
                list.innerHTML = '';
                let users = [];
                let adminExists = false;

                snapshot.forEach(d => {
                    const u = d.data();
                    users.push(u);
                    if (u.role === 'admin') adminExists = true;
                    
                    if (u.uid === currentUser.uid) {
                        myRole = u.role;
                        if (u.mutedByAdmin && !iAmMuted) {
                             iAmMuted = true;
                             muteMyMic(true);
                             showNotification("Администратор отключил вам микрофон");
                        } else if (!u.mutedByAdmin && iAmMuted) {
                             iAmMuted = false;
                             muteMyMic(false);
                             showNotification("Микрофон снова доступен");
                        }
                    }
                });

                if (!adminExists && users.length > 0) {
                    users.sort((a, b) => {
                        const tA = a.joinedAt ? a.joinedAt.seconds : Date.now()/1000;
                        const tB = b.joinedAt ? b.joinedAt.seconds : Date.now()/1000;
                        return tA - tB;
                    });
                    if (users[0].uid === currentUser.uid) {
                        updateDoc(userRef, { role: 'admin' });
                        showNotification("Вы стали администратором комнаты!");
                    }
                }

                users.forEach(u => {
                    const el = document.createElement('div');
                    el.className = "flex items-center gap-3 p-2 hover:bg-white/5 rounded-xl cursor-pointer sidebar-item justify-between";
                    
                    let roleBadge = u.role === 'admin' ? '<i class="fa-solid fa-crown admin-crown ml-1"></i>' : '';
                    let muteBtn = '';

                    if (myRole === 'admin' && u.uid !== currentUser.uid) {
                        const icon = u.mutedByAdmin ? 'fa-microphone-slash text-red-400' : 'fa-microphone text-white/20 hover:text-white';
                        muteBtn = `<button class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center transition" onclick="toggleMuteUser('${u.uid}', ${!u.mutedByAdmin})"><i class="fa-solid ${icon}"></i></button>`;
                    } else if (u.mutedByAdmin) {
                        muteBtn = `<span class="text-red-500/50 text-xs"><i class="fa-solid fa-microphone-slash"></i></span>`;
                    }

                    el.innerHTML = `
                        <div class="flex items-center gap-3">
                            <img src="${u.photoURL}" class="w-8 h-8 rounded-full bg-white/10">
                            <div class="flex flex-col">
                                <span class="text-xs font-bold">${u.displayName} ${roleBadge}</span>
                                <span class="text-[9px] text-white/40 uppercase">${u.role}</span>
                            </div>
                        </div>
                        ${muteBtn}
                    `;
                    list.appendChild(el);
                });
                
                if(users.length > 0) get('badge-users').classList.remove('hidden');
            });

            get('screen-lobby').classList.add('force-hidden');
            get('screen-app').classList.remove('force-hidden');
            setInterval(() => { setDoc(userRef, { lastActive: serverTimestamp() }, { merge: true }); }, 30000);
        }

        // --- ADMIN FUNCTIONS ---
        window.toggleMuteUser = (targetUid, newState) => {
             if (myRole !== 'admin') return;
             updateDoc(doc(db, 'artifacts', APP_ID, 'rooms', currentRoomId, 'presence', targetUid), { mutedByAdmin: newState });
        }
        
        function muteMyMic(isMuted) {
            const btn = get('btn-toggle-voice');
            if (isMuted) {
                btn.classList.add('disabled');
                btn.innerHTML = '<i class="fa-solid fa-microphone-slash text-red-500"></i>';
            } else {
                btn.classList.remove('disabled');
                btn.innerHTML = '<i class="fa-solid fa-microphone-slash"></i>';
            }
        }

        // --- UI LOGIC ---
        get('tab-chat').onclick = () => {
            get('tab-chat').classList.replace('bg-white/5', 'text-white'); get('tab-chat').classList.remove('text-white/40');
            get('tab-users').classList.add('text-white/40'); get('tab-users').classList.remove('bg-white/5');
            get('view-chat').classList.remove('hidden'); get('view-users').classList.add('hidden');
        };
        get('tab-users').onclick = () => {
            get('tab-users').classList.replace('text-white/40', 'bg-white/5'); get('tab-users').classList.add('text-white');
            get('tab-chat').classList.add('text-white/40'); get('tab-chat').classList.remove('bg-white/5');
            get('view-users').classList.remove('hidden'); get('view-chat').classList.add('hidden');
        };
        
        get('btn-toggle-sidebar').onclick = () => get('sidebar').classList.toggle('active');
        
        get('form-chat').onsubmit = (e) => {
            e.preventDefault();
            const input = get('input-chat');
            const text = input.value.trim();
            if(!text || !currentRoomId) return;
            addDoc(collection(db, 'artifacts', APP_ID, 'rooms', currentRoomId, 'messages'), {
                text, user: currentUser.displayName, uid: currentUser.uid, createdAt: serverTimestamp()
            });
            input.value = '';
        };

        // --- VIDEO ENGINE ---
        let activeProvider = 'none';
        let ytPlayer = null;
        let isNativeMode = false;

        get('btn-load-video').onclick = () => {
            if (myRole !== 'admin') {
                showNotification("Только администратор может менять видео");
                return;
            }
            const url = get('input-video-url').value.trim();
            if(!url) return;
            
            let provider = 'yt', videoId = '';
            const vkRegex = /video(-?\d+)_(\d+)/;
            const vkMatch = url.match(vkRegex);
            const ytMatch = url.match(/(?:v=|\/)([\w-]{11})/);

            if (vkMatch) {
                provider = 'vk'; videoId = `https://vk.com/video_ext.php?oid=${vkMatch[1]}&id=${vkMatch[2]}&hd=2&autoplay=1`;
            } else if (url.includes('vk.com/video_ext.php')) {
                provider = 'vk'; videoId = url;
            } else if (ytMatch) {
                provider = 'yt'; videoId = ytMatch[1];
            }

            setDoc(doc(db, 'artifacts', APP_ID, 'rooms', currentRoomId), { 
                provider, videoId, status: 'playing', timestamp: 0, updatedAt: Date.now() 
            }, { merge: true });
            get('input-video-url').value = '';
        };

        function syncState(d) {
            if (d.videoId) get('player-placeholder').style.display = 'none';
            
            if (d.provider !== activeProvider) {
                activeProvider = d.provider;
                document.querySelectorAll('#video-layer > div, #video-layer > video').forEach(el => {
                     if(el.id !== 'click-overlay') el.classList.add('force-hidden');
                });

                if (d.provider === 'yt') get('player-yt').classList.remove('force-hidden');
                if (d.provider === 'vk') get('player-vk-container').classList.remove('force-hidden');
                if (d.provider === 'screen') {
                     get('player-stream').classList.remove('force-hidden');
                     connectToStream(d.streamPeerId);
                }

                if(d.provider !== 'yt') {
                    get('timeline-container').style.opacity = '0.5'; get('timeline-container').style.pointerEvents = 'none';
                } else {
                    get('timeline-container').style.opacity = '1'; get('timeline-container').style.pointerEvents = 'auto';
                }
            }

            if (d.provider === 'vk') {
                const f = get('player-vk-container');
                if (!f.querySelector('iframe') || f.querySelector('iframe').src !== d.videoId) {
                    f.innerHTML = `<iframe src="${d.videoId}" allow="autoplay; fullscreen" frameborder="0"></iframe>`;
                }
            }
            
            if (d.provider === 'yt' && ytPlayer && ytPlayer.loadVideoById) {
                try {
                    const diff = Math.abs(ytPlayer.getCurrentTime() - d.timestamp);
                    if(ytPlayer.getVideoData().video_id !== d.videoId) ytPlayer.loadVideoById(d.videoId);
                    if(d.status === 'playing') ytPlayer.playVideo(); else ytPlayer.pauseVideo();
                    if(diff > 2) ytPlayer.seekTo(d.timestamp);
                    
                    if(d.status === 'playing') {
                        get('btn-play-pause').innerHTML = '<i class="fa-solid fa-pause"></i>';
                        get('status-text').innerText = "PLAYING";
                        get('status-dot').className = "w-2 h-2 bg-green-500 rounded-full animate-pulse";
                    } else {
                        get('btn-play-pause').innerHTML = '<i class="fa-solid fa-play"></i>';
                        get('status-text').innerText = "PAUSED";
                        get('status-dot').className = "w-2 h-2 bg-yellow-500 rounded-full";
                    }
                } catch(e) {}
            }
        }

        // --- YOUTUBE API ---
        if(!window.YT) { const t = document.createElement('script'); t.src = "https://www.youtube.com/iframe_api"; document.body.appendChild(t); }
        window.onYouTubeIframeAPIReady = () => {
            ytPlayer = new YT.Player('player-yt', {
                height: '100%', width: '100%',
                playerVars: { 'controls': 0, 'rel': 0, 'origin': window.location.origin },
                events: {
                    'onStateChange': (e) => {
                        if (!currentRoomId || isNativeMode) return;
                        if (myRole !== 'admin') return;

                        if (e.data === 1 || e.data === 2) {
                            setDoc(doc(db, 'artifacts', APP_ID, 'rooms', currentRoomId), {
                                status: e.data === 1 ? 'playing' : 'paused',
                                timestamp: ytPlayer.getCurrentTime()
                            }, { merge: true });
                        }
                    }
                }
            });
            setInterval(() => {
                if(ytPlayer && ytPlayer.getCurrentTime) {
                    const t = ytPlayer.getCurrentTime();
                    const d = ytPlayer.getDuration();
                    get('time-current').innerText = formatTime(t);
                    get('time-duration').innerText = formatTime(d);
                    get('seek-bar').value = (t / d) * 100 || 0;
                }
            }, 1000);
        };

        // --- KEYBOARD & CONTROLS ---
        document.addEventListener('keydown', (e) => {
            if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') return;
            
            if (activeProvider === 'yt' && ytPlayer && currentRoomId) {
                const current = ytPlayer.getCurrentTime();
                if (myRole !== 'admin') {
                     if (e.code === 'Space' || e.code === 'ArrowRight' || e.code === 'ArrowLeft') showNotification("Управление доступно только админу");
                     return;
                }

                if (e.code === 'Space') { e.preventDefault(); togglePlay(); } 
                else if (e.code === 'ArrowRight') { e.preventDefault(); const newTime = current + 5; ytPlayer.seekTo(newTime); setDoc(doc(db, 'artifacts', APP_ID, 'rooms', currentRoomId), { timestamp: newTime }, { merge: true }); } 
                else if (e.code === 'ArrowLeft') { e.preventDefault(); const newTime = Math.max(0, current - 5); ytPlayer.seekTo(newTime); setDoc(doc(db, 'artifacts', APP_ID, 'rooms', currentRoomId), { timestamp: newTime }, { merge: true }); }
            }
        });

        window.togglePlay = () => {
            if (myRole !== 'admin') { showNotification("Только админ может ставить на паузу"); return; }
            if (activeProvider === 'yt' && ytPlayer) {
                const s = ytPlayer.getPlayerState();
                setDoc(doc(db, 'artifacts', APP_ID, 'rooms', currentRoomId), { 
                    status: s === 1 ? 'paused' : 'playing', timestamp: ytPlayer.getCurrentTime() 
                }, { merge: true });
            }
        };

        get('seek-bar').oninput = (e) => {
             if (myRole !== 'admin') { showNotification("Перемотка доступна только админу"); return; }
             if (activeProvider === 'yt' && ytPlayer) {
                 const time = (e.target.value / 100) * ytPlayer.getDuration();
                 ytPlayer.seekTo(time);
                 setDoc(doc(db, 'artifacts', APP_ID, 'rooms', currentRoomId), { timestamp: time }, { merge: true });
             }
        };

        window.toggleNativeMode = () => {
            isNativeMode = !isNativeMode;
            const ui = get('ui-layer');
            const overlay = get('click-overlay');
            const hint = get('native-mode-hint');
            const btn = get('btn-toggle-sidebar');

            if (isNativeMode) {
                ui.style.opacity = '0'; ui.style.pointerEvents = 'none';
                btn.classList.add('force-hidden'); // Hide chat button in native mode
                overlay.style.display = 'none'; hint.style.opacity = '1';
                showNotification("Режим Native: UI скрыт");
            } else {
                ui.style.opacity = '1';
                btn.classList.remove('force-hidden');
                overlay.style.display = 'block'; hint.style.opacity = '0';
            }
        };

        let peer = null;
        get('btn-screen-share').onclick = () => {
            if(!peer) peer = new Peer();
            peer.on('open', (id) => {
                navigator.mediaDevices.getDisplayMedia({ video: true, audio: true }).then(stream => {
                    const video = get('player-stream'); video.srcObject = stream; video.classList.remove('force-hidden');
                    setDoc(doc(db, 'artifacts', APP_ID, 'rooms', currentRoomId), { provider: 'screen', streamPeerId: id, status: 'playing' }, { merge: true });
                    peer.on('call', call => call.answer(stream));
                });
            });
        };

        function connectToStream(hostId) {
            if(!hostId || !get('player-stream').classList.contains('force-hidden')) return;
            if(!peer) peer = new Peer();
            peer.on('open', () => {
                const call = peer.call(hostId, new MediaStream());
                call.on('stream', remoteStream => { get('player-stream').srcObject = remoteStream; get('player-stream').play(); });
            });
        }
        
        let uiTimer;
        const resetUi = () => {
            if(isNativeMode) return;
            const ui = get('ui-layer');
            const chatBtn = get('btn-toggle-sidebar');
            ui.style.opacity = '1';
            chatBtn.style.opacity = '1';
            
            clearTimeout(uiTimer);
            uiTimer = setTimeout(() => {
                if(document.activeElement.tagName !== 'INPUT' && !get('sidebar').classList.contains('active')) {
                     ui.style.opacity = '0';
                     chatBtn.style.opacity = '0';
                }
            }, 4000);
        };
        document.onmousemove = resetUi;
        document.onclick = resetUi;

    </script>
</body>
</html>
