<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="origin-when-cross-origin">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;">
    <title>Co-Watch | Батя Edition (iOS Fix)</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <style>
        /* CORE & FX */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            scrollbar-width: none;
            outline: none;
            user-select: none; /* Helps UI feel more app-like */
        }

        ::-webkit-scrollbar {
            display: none;
        }

        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #050505;
            font-family: 'Manrope', sans-serif;
            color: #fff;
        }

        .noise-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            opacity: 0.03;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }

        /* GLASS UI */
        .glass-panel {
            background: rgba(18, 18, 18, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .glass-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s ease;
            cursor: pointer;
            touch-action: manipulation;
        }

        .glass-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
        }

        .glass-btn:active {
            transform: translateY(1px);
        }

        .glass-btn.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .sidebar-item {
            transition: 0.2s;
            border-radius: 12px;
        }

        .sidebar-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        /* PLAYERS & LAYOUT */
        #video-layer {
            position: fixed;
            inset: 0;
            z-index: 5;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #player-yt,
        #player-vk-container,
        #player-stream {
            width: 100%;
            height: 100%;
            position: absolute;
            inset: 0;
        }

        /* IOS FIX: Ensure iframe captures pointer events properly */
        #video-layer iframe {
            width: 100% !important;
            height: 100% !important;
            border: none;
            pointer-events: auto !important;
        }

        /* UI LAYERS & MOBILE ADAPTATION */
        #ui-layer {
            position: fixed;
            inset: 0;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: max(env(safe-area-inset-top), 20px) 16px env(safe-area-inset-bottom) 16px;
            pointer-events: none;
        }

        #ui-layer>* {
            pointer-events: auto;
        }

        /* NATIVE MODE */
        body.native-mode #ui-layer {
            pointer-events: none !important;
            padding: 0 !important;
        }

        body.native-mode #top-bar,
        body.native-mode #sidebar,
        body.native-mode #timeline-container,
        body.native-mode #status-panel-container {
            display: none !important;
        }

        body.native-mode #bottom-bar {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            backdrop-filter: none !important;
            pointer-events: none !important;
            height: 0 !important;
            padding: 0 !important;
            margin: 0 !important;
            overflow: visible !important;
        }

        body.native-mode #bottom-controls-panel {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            backdrop-filter: none !important;
            pointer-events: none !important;
            display: block !important;
            height: 0 !important;
            padding: 0 !important;
        }

        body.native-mode #bottom-controls-panel>*:not(#btn-native) {
            display: none !important;
        }

        body.native-mode #btn-native {
            display: flex !important;
            pointer-events: auto !important;
            position: fixed !important;
            bottom: 40px !important;
            right: 20px !important;
            z-index: 10002 !important;
            background-color: rgba(220, 38, 38, 0.6) !important;
            color: white !important;
            border-color: transparent !important;
            opacity: 0.6 !important;
            transform: scale(0.9);
        }

        body.native-mode #btn-native:hover,
        body.native-mode #btn-native:active {
            opacity: 1 !important;
            transform: scale(1.0);
        }

        #top-bar {
            z-index: 10001 !important;
        }

        @media (max-width: 767px) {
            #top-bar {
                transform: translateZ(0);
                -webkit-transform: translateZ(0);
            }
        }

        #top-bar,
        #bottom-bar {
            position: relative;
        }

        /* SIDEBAR (CHAT) */
        #sidebar {
            position: fixed;
            z-index: 20000;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s;
            display: flex;
            flex-direction: column;
            left: 0;
            right: 0;
            bottom: 0;
            height: 75vh;
            border-radius: 24px 24px 0 0;
            transform: translateY(120%);
        }

        #sidebar.active {
            transform: translateY(0);
        }

        @media (min-width: 768px) {
            #sidebar {
                left: auto;
                right: 20px;
                top: 80px;
                bottom: 100px;
                width: 320px;
                height: auto;
                border-radius: 24px;
                transform: translateX(120%);
            }

            #sidebar.active {
                transform: translateX(0);
            }
        }

        .chat-msg {
            animation: fadeIn 0.3s ease;
            margin-bottom: 8px;
            font-size: 14px;
            line-height: 1.4;
            word-break: break-word;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .seek-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 4px;
            outline: none;
            cursor: pointer;
            position: relative;
        }

        .seek-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            transition: transform 0.1s;
            margin-top: 0px;
        }

        /* TOAST */
        #notification-area {
            position: fixed;
            top: 80px;
            left: 20px;
            right: 20px;
            z-index: 20002;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        @media (min-width: 768px) {
            #notification-area {
                top: auto;
                bottom: 30px;
                left: auto;
                right: 30px;
                align-items: flex-end;
            }
        }

        .toast {
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-left: 4px solid #fbbf24;
            padding: 14px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
            color: #fff;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            max-width: 100%;
            width: max-content;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1);
            pointer-events: auto;
            word-break: break-word;
        }

        .toast b {
            color: #fbbf24;
            font-weight: 700;
            margin-right: 6px;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast.hiding {
            opacity: 0;
            transform: scale(0.95) translateY(-10px);
        }

        .force-hidden {
            display: none !important;
        }

        #mobile-url-modal {
            z-index: 20005;
        }

        /* IOS "KICKSTART" OVERLAY */
        #ios-kickstart {
            position: absolute;
            inset: 0;
            z-index: 20;
            background: rgba(0,0,0,0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            backdrop-filter: blur(2px);
        }
    </style>
</head>

<body onclick="unlockAudio()">

    <div class="noise-bg"></div>
    <div id="notification-area"></div>

    <div id="screen-auth"
        class="fixed inset-0 z-[100] flex items-center justify-center bg-[#050505] p-4 transition-opacity duration-500">
        <div
            class="glass-panel p-8 md:p-10 rounded-[32px] max-w-sm w-full text-center pointer-events-auto relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500">
            </div>
            <h1 class="text-4xl md:text-5xl font-extrabold mb-2 tracking-tighter">Co-Watch</h1>
            <p class="text-gray-400 mb-8 text-sm font-mono uppercase tracking-widest">Batya Edition</p>

            <button id="btn-google-login"
                class="w-full bg-white text-black font-bold py-4 rounded-xl mb-3 hover:bg-gray-200 transition active:scale-95">
                <i class="fa-brands fa-google mr-2"></i> Войти
            </button>
            <button id="btn-guest-login" class="w-full glass-btn py-4 rounded-xl text-sm font-semibold active:scale-95">
                Гость
            </button>
        </div>
    </div>

    <div id="screen-lobby"
        class="fixed inset-0 z-[90] flex items-center justify-center bg-[#050505] force-hidden pointer-events-auto overflow-y-auto">
        <div class="w-full max-w-5xl p-4 md:p-6 flex flex-col md:flex-row gap-6 min-h-[80vh] md:h-[70vh]">
            <div
                class="w-full md:w-1/3 glass-panel rounded-3xl p-6 flex flex-col items-center justify-center relative shrink-0">
                <img id="lobby-avatar"
                    class="w-24 h-24 md:w-32 md:h-32 rounded-full mb-4 md:mb-6 object-cover border-4 border-white/10 shadow-2xl">
                <h2 class="text-xl md:text-2xl font-bold mb-2 text-center break-all"><span
                        id="lobby-username">Guest</span></h2>
                <button id="btn-logout"
                    class="text-xs text-red-400 hover:text-red-300 border border-red-500/20 px-4 py-2 rounded-full transition">Выйти</button>
            </div>

            <div
                class="w-full md:w-2/3 glass-panel rounded-3xl p-6 md:p-10 flex flex-col justify-center space-y-6 relative overflow-hidden shrink-0">
                <div class="absolute -right-20 -top-20 w-64 h-64 bg-purple-600/20 rounded-full blur-[100px]"></div>
                <h3 class="text-2xl md:text-3xl font-bold mb-2">Кинозал</h3>

                <button id="btn-create-room"
                    class="w-full bg-white text-black py-4 md:py-5 rounded-2xl font-bold text-lg hover:scale-[1.01] transition shadow-[0_0_30px_rgba(255,255,255,0.2)] active:scale-95">
                    <i class="fa-solid fa-plus mr-2"></i> Создать комнату
                </button>

                <div class="flex flex-col md:flex-row gap-3 pt-4 border-t border-white/10">
                    <input id="input-room-id" placeholder="ID комнаты..."
                        class="w-full bg-black/30 border border-white/10 rounded-2xl px-6 py-4 md:py-0 text-lg font-mono outline-none focus:border-white/40 transition text-center md:text-left uppercase">
                    <button id="btn-join-room"
                        class="glass-btn w-full md:w-auto px-8 py-4 md:py-0 rounded-2xl font-bold text-lg hover:bg-white hover:text-black active:scale-95">GO</button>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-app" class="fixed inset-0 bg-black force-hidden">

        <div id="video-layer">
            <div id="player-placeholder" class="flex flex-col items-center justify-center p-4 text-center">
                <div
                    class="w-20 h-20 md:w-24 md:h-24 rounded-full border border-white/10 flex items-center justify-center mb-6 animate-pulse">
                    <i class="fa-solid fa-film text-3xl md:text-4xl text-white/30"></i>
                </div>
                <p class="text-white/30 font-mono tracking-[0.2em] text-xs md:text-sm">ЖДЕМ ВИДЕО ОТ БАТИ</p>
            </div>
            
            <div id="player-yt" class="force-hidden z-10"></div>
            
            <div id="ios-kickstart" class="force-hidden">
                <div class="flex flex-col items-center animate-pulse">
                    <div class="w-20 h-20 bg-red-600 rounded-full flex items-center justify-center shadow-lg mb-2">
                        <i class="fa-solid fa-play text-3xl ml-1"></i>
                    </div>
                    <span class="text-xs font-bold uppercase tracking-widest text-white/80">Tap to Sync</span>
                </div>
            </div>

            <div id="player-vk-container" class="force-hidden z-10"></div>
            <video id="player-stream" class="force-hidden z-10 object-contain w-full h-full" autoplay playsinline></video>
        </div>

        <div id="ui-layer">

            <div id="top-bar" class="flex justify-between items-start md:items-center transition-ui opacity-100 gap-2">
                <div class="glass-panel pl-2 pr-4 py-2 rounded-full flex gap-3 items-center cursor-pointer hover:bg-white/5 transition shrink-0"
                    id="copy-room-id" onclick="void(0)">
                    <div
                        class="w-8 h-8 bg-green-500/20 rounded-full flex items-center justify-center text-green-400 shrink-0">
                        <i class="fa-solid fa-link text-xs"></i>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-[9px] text-white/40 font-bold uppercase hidden md:block">Room ID</span>
                        <span id="display-room-id"
                            class="font-mono font-bold leading-none tracking-wider text-sm">...</span>
                    </div>
                </div>

                <div class="hidden md:flex glass-panel p-1.5 rounded-full gap-2 w-full max-w-lg mx-4 shadow-lg">
                    <input id="input-video-url" placeholder="YouTube / VK / Direct Link..."
                        class="bg-transparent flex-1 px-4 outline-none text-sm text-white font-medium placeholder-white/20">
                    <button id="btn-load-video"
                        class="w-9 h-9 bg-white text-black rounded-full flex items-center justify-center hover:scale-105 transition"><i
                            class="fa-solid fa-play ml-0.5 text-xs"></i></button>
                </div>

                <button onclick="toggleMobileUrlModal()"
                    class="md:hidden glass-panel w-10 h-10 rounded-full flex items-center justify-center text-white active:scale-95">
                    <i class="fa-solid fa-plus"></i>
                </button>

                <div class="flex gap-2 md:gap-3">
                    <button id="btn-toggle-sidebar"
                        class="glass-panel w-10 h-10 md:w-10 md:h-10 rounded-full flex items-center justify-center text-white/70 hover:text-white hover:bg-white/10 relative active:scale-95">
                        <i class="fa-solid fa-comment-dots md:hidden"></i> <i
                            class="fa-solid fa-user-group hidden md:block"></i> <span id="badge-users"
                            class="absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 rounded-full border border-black hidden"></span>
                    </button>
                    <button id="btn-leave-room"
                        class="glass-panel w-10 h-10 md:w-10 md:h-10 rounded-full flex items-center justify-center text-red-400 hover:bg-red-500/10 active:scale-95"
                        title="Покинуть комнату">
                        <i class="fa-solid fa-right-from-bracket"></i>
                    </button>
                </div>
            </div>

            <div id="sidebar" class="glass-panel overflow-hidden flex flex-col shadow-2xl pb-safe">
                <div class="md:hidden w-full flex justify-center pt-3 pb-1"
                    onclick="get('sidebar').classList.remove('active')">
                    <div class="w-12 h-1.5 bg-white/20 rounded-full"></div>
                </div>

                <div class="flex border-b border-white/5 shrink-0">
                    <button id="tab-chat"
                        class="flex-1 py-4 md:py-3 text-xs font-bold uppercase tracking-wider bg-white/5">Чат</button>
                    <button id="tab-users"
                        class="flex-1 py-4 md:py-3 text-xs font-bold uppercase tracking-wider text-white/40 hover:text-white">Люди</button>
                </div>

                <div id="view-chat" class="flex-1 flex flex-col min-h-0 relative">
                    <div id="chat-messages" class="flex-1 overflow-y-auto p-4 flex flex-col gap-2"></div>
                    <div class="p-3 border-t border-white/5 bg-black/40">
                        <form id="form-chat" class="flex gap-2">
                            <input id="input-chat"
                                class="flex-1 bg-white/10 rounded-xl px-4 py-3 text-sm outline-none focus:bg-white/20 transition text-white"
                                placeholder="Сообщение..." autocomplete="off">
                            <button type="submit"
                                class="w-11 h-11 bg-white text-black rounded-xl flex items-center justify-center transition active:scale-95"><i
                                    class="fa-solid fa-paper-plane text-sm"></i></button>
                        </form>
                    </div>
                </div>

                <div id="view-users" class="flex-1 overflow-y-auto p-2 hidden">
                    <div id="list-users" class="flex flex-col gap-1"></div>
                </div>
            </div>

            <div id="bottom-bar"
                class="flex flex-col gap-3 md:gap-4 transition-ui w-full max-w-2xl mx-auto pb-2 md:pb-6 opacity-100">

                <div id="timeline-container"
                    class="glass-panel px-4 py-3 md:px-5 md:py-3 rounded-2xl flex items-center gap-3 md:gap-4">
                    <button id="btn-play-pause"
                        class="w-8 h-8 md:w-6 md:h-6 flex items-center justify-center text-white/80 hover:text-white transition active:scale-90"
                        onclick="togglePlay()">
                        <i class="fa-solid fa-play text-lg md:text-base"></i>
                    </button>
                    <span id="time-current" class="text-xs font-mono text-white/50 w-8 md:w-10 text-right">0:00</span>
                    <input type="range" id="seek-bar" class="seek-slider flex-1" min="0" max="100" value="0">
                    <span id="time-duration" class="text-xs font-mono text-white/50 w-8 md:w-10">0:00</span>
                </div>

                <div id="bottom-controls-panel"
                    class="glass-panel p-2 md:p-2 rounded-2xl flex justify-between md:justify-center gap-2 md:gap-4 items-center overflow-x-auto">
                    <button id="btn-toggle-voice"
                        class="glass-btn w-12 h-12 rounded-xl flex items-center justify-center text-xl text-white/30 shrink-0"
                        title="Голос"><i class="fa-solid fa-microphone-slash"></i></button>
                    <button id="btn-screen-share"
                        class="glass-btn w-12 h-12 rounded-xl flex items-center justify-center text-xl text-purple-400 hover:text-purple-300 hover:bg-purple-500/10 shrink-0 hidden md:flex"
                        title="Демонстрация экрана"><i class="fa-solid fa-desktop"></i></button>

                    <div id="status-panel-container" class="flex flex-col items-center px-2 md:px-4 shrink-0">
                        <span class="text-[9px] text-white/30 uppercase tracking-widest font-bold">Status</span>
                        <div class="flex items-center gap-2">
                            <div id="status-dot" class="w-2 h-2 bg-green-500 rounded-full shadow-[0_0_10px_#22c55e]">
                            </div>
                            <span id="status-text" class="text-xs font-bold text-green-400">READY</span>
                        </div>
                    </div>

                    <button id="btn-toggle-permissions"
                        class="glass-btn w-12 h-12 rounded-xl flex items-center justify-center text-xl text-white/30 shrink-0 hidden"
                        onclick="toggleGuestPermissions()" title="Разрешить управление гостям"><i
                            class="fa-solid fa-lock"></i></button>

                    <button id="btn-native"
                        class="glass-btn w-12 h-12 rounded-xl flex items-center justify-center text-xl text-blue-400 hover:text-blue-300 shrink-0"
                        onclick="toggleNativeMode()" title="Режим Native"><i class="fa-solid fa-gear"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div id="mobile-url-modal"
        class="fixed inset-0 z-[80] bg-black/80 backdrop-blur-sm flex items-end md:items-center justify-center p-4 force-hidden opacity-0 transition-opacity duration-300">
        <div
            class="glass-panel w-full max-w-lg p-5 rounded-2xl transform transition-transform duration-300 translate-y-10">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">Поставить видео</h3>
                <button onclick="toggleMobileUrlModal()"
                    class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center"><i
                        class="fa-solid fa-times"></i></button>
            </div>
            <input id="input-video-url-mobile" placeholder="Ссылка (YouTube / VK)..."
                class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-white mb-3 outline-none focus:border-white/30">
            <button id="btn-load-video-mobile"
                class="w-full bg-white text-black font-bold py-3 rounded-xl active:scale-95 transition">Включить</button>
            <p class="text-white/30 text-xs mt-3 text-center">Вставьте ссылку на видео или ID комнаты VK</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInAnonymously, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, serverTimestamp, addDoc, query, orderBy, limit, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = { apiKey: "AIzaSyBrm8hgy9LGFFL_7CdlnR6jxyolqy94AQA", authDomain: "upbeat-orb-479013-p8.firebaseapp.com", projectId: "upbeat-orb-479013-p8", storageBucket: "upbeat-orb-479013-p8.firebasestorage.app", messagingSenderId: "547138498300", appId: "1:547138498300:web:a03c11d6aafd5f027cf179" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const APP_ID = 'cw-admin-ux-final-v4-ios-fix'; // Version Bumped

        const get = (id) => document.getElementById(id);
        const formatTime = (s) => { const m = Math.floor(s / 60), sec = Math.floor(s % 60); return `${m}:${sec < 10 ? '0' : ''}${sec}`; };
        window.unlockAudio = () => { const a = new (window.AudioContext || window.webkitAudioContext)(); if (a.state === 'suspended') a.resume(); };

        // --- MOBILE MODAL LOGIC ---
        window.toggleMobileUrlModal = () => {
            const modal = get('mobile-url-modal');
            if (modal.classList.contains('force-hidden')) {
                modal.classList.remove('force-hidden');
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    modal.querySelector('div').classList.remove('translate-y-10');
                }, 10);
            } else {
                modal.classList.add('opacity-0');
                modal.querySelector('div').classList.add('translate-y-10');
                setTimeout(() => modal.classList.add('force-hidden'), 300);
            }
        };

        get('btn-load-video-mobile').onclick = () => {
            const url = get('input-video-url-mobile').value.trim();
            if (url) {
                get('input-video-url').value = url;
                get('btn-load-video').click();
                toggleMobileUrlModal();
                get('input-video-url-mobile').value = '';
            }
        };

        // --- UX: NOTIFICATIONS ---
        window.showNotification = (text) => {
            const area = get('notification-area');
            if (!area) return;

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = text;
            area.appendChild(toast);
            requestAnimationFrame(() => { toast.classList.add('show'); });
            setTimeout(() => {
                toast.classList.remove('show');
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 600);
            }, 5000);
        };

        // --- AUTH ---
        onAuthStateChanged(auth, u => {
            if (u) {
                get('lobby-username').textContent = u.displayName || 'Guest';
                const seed = u.uid;
                get('lobby-avatar').src = u.photoURL || `https://api.dicebear.com/7.x/adventurer/svg?seed=${seed}&backgroundColor=b6e3f4,c0aede,d1d4f9`;
                get('screen-auth').classList.add('force-hidden');
                get('screen-lobby').classList.remove('force-hidden');
            } else {
                get('screen-auth').classList.remove('force-hidden');
                get('screen-lobby').classList.add('force-hidden');
                get('screen-app').classList.add('force-hidden');
            }
        });

        get('btn-google-login').onclick = () => signInWithPopup(auth, new GoogleAuthProvider()).catch(e => alert(e.message));
        get('btn-guest-login').onclick = () => signInAnonymously(auth).then(c => updateProfile(c.user, { displayName: `Watcher ${Math.floor(Math.random() * 100)}` }));
        get('btn-logout').onclick = () => signOut(auth);

        // --- ROOMS & ADMIN SYSTEM ---
        let currentRoomId = null;
        let currentUser = null;
        let myRole = 'viewer';
        let iAmMuted = false;
        let chatInitialized = false;
        let presenceUnsub = null;
        let chatUnsub = null;
        let roomUnsub = null;
        let heartbeatInterval = null;

        get('btn-create-room').onclick = () => { const id = Math.random().toString(36).substring(2, 7).toUpperCase(); joinRoom(id, true); };
        get('btn-join-room').onclick = () => { const id = get('input-room-id').value.trim().toUpperCase(); if (id) joinRoom(id); };

        get('copy-room-id').onclick = () => {
            navigator.clipboard.writeText(currentRoomId);
            showNotification(`<i class="fa-solid fa-check mr-2"></i> ID скопирован`);
        };

        get('btn-leave-room').onclick = async () => {
            if (!currentRoomId || !currentUser) return;

            if (presenceUnsub) presenceUnsub();
            if (chatUnsub) chatUnsub();
            if (roomUnsub) roomUnsub();
            if (heartbeatInterval) clearInterval(heartbeatInterval);

            try {
                await deleteDoc(doc(db, 'artifacts', APP_ID, 'rooms', currentRoomId, 'presence', currentUser.uid));
            } catch (e) { console.error("Ошибка при выходе:", e); }

            if (peer) { peer.destroy(); peer = null; }
            
            // CLEAN UP PLAYER SAFELY
            try {
                if (ytPlayer && ytPlayer.destroy) ytPlayer.destroy();
                ytPlayer = null;
            } catch(e) {}

            get('player-yt').innerHTML = '';
            get('player-vk-container').innerHTML = '';
            const vStream = get('player-stream');
            vStream.srcObject = null;
            vStream.classList.add('force-hidden');

            get('screen-app').classList.add('force-hidden');
            get('screen-lobby').classList.remove('force-hidden');
            get('sidebar').classList.remove('active');
            get('chat-messages').innerHTML = '';
            currentRoomId = null;
            myRole = 'viewer';
            activeProvider = 'none';
        };

        async function joinRoom(id, isCreator = false) {
            currentRoomId = id;
            currentUser = auth.currentUser;
            get('display-room-id').textContent = id;
            chatInitialized = false;

            const userRef = doc(db, 'artifacts', APP_ID, 'rooms', id, 'presence', currentUser.uid);
            await setDoc(userRef, {
                uid: currentUser.uid,
                displayName: currentUser.displayName,
                photoURL: currentUser.photoURL || `https://api.dicebear.com/7.x/adventurer/svg?seed=${currentUser.uid}&backgroundColor=b6e3f4,c0aede,d1d4f9`,
                role: isCreator ? 'admin' : 'viewer',
                joinedAt: serverTimestamp(),
                lastActive: serverTimestamp(),
                mutedByAdmin: false
            });

            roomUnsub = onSnapshot(doc(db, 'artifacts', APP_ID, 'rooms', id), s => { if (s.exists()) syncState(s.data()); });

            const chatQ = query(collection(db, 'artifacts', APP_ID, 'rooms', id, 'messages'), orderBy('createdAt', 'asc'), limit(50));
            chatUnsub = onSnapshot(chatQ, snapshot => {
                const div = get('chat-messages');
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const msg = change.doc.data();
                        const el = document.createElement('div');
                        el.className = 'chat-msg flex flex-col';
                        el.innerHTML = `<span class="text-[10px] font-bold text-white/50 mb-0.5">${msg.user}</span><span class="bg-white/10 p-2 rounded-xl rounded-tl-none self-start">${msg.text}</span>`;

                        if (msg.uid === currentUser.uid) {
                            el.innerHTML = `<span class="bg-blue-500/20 p-2 rounded-xl rounded-tr-none self-end">${msg.text}</span>`;
                        }
                        div.appendChild(el);
                        if (chatInitialized && msg.uid !== currentUser.uid && !get('sidebar').classList.contains('active')) {
                            showNotification(`<b>${msg.user}:</b> ${msg.text}`);
                        }
                    }
                });
                chatInitialized = true;
                div.scrollTop = div.scrollHeight;
            });

            presenceUnsub = onSnapshot(collection(db, 'artifacts', APP_ID, 'rooms', id, 'presence'), snapshot => {
                const list = get('list-users');
                list.innerHTML = '';
                let users = [];
                let adminExists = false;

                snapshot.forEach(d => {
                    const u = d.data();
                    users.push(u);
                    if (u.role === 'admin') adminExists = true;

                    if (u.uid === currentUser.uid) {
                        myRole = u.role;
                        updatePermissionsUI(); 
                        if (u.mutedByAdmin && !iAmMuted) {
                            iAmMuted = true;
                            muteMyMic(true);
                            showNotification("<i class='fa-solid fa-microphone-slash mr-2 text-red-500'></i> Батя выключил вам микрофон");
                        } else if (!u.mutedByAdmin && iAmMuted) {
                            iAmMuted = false;
                            muteMyMic(false);
                            showNotification("<i class='fa-solid fa-microphone mr-2 text-green-500'></i> Микрофон доступен");
                        }
                    }
                });

                if (!snapshot.metadata.hasPendingWrites && !adminExists && users.length > 0) {
                    users.sort((a, b) => {
                        const tA = a.joinedAt ? a.joinedAt.seconds : Date.now() / 1000;
                        const tB = b.joinedAt ? b.joinedAt.seconds : Date.now() / 1000;
                        return tA - tB;
                    });
                    if (users[0].uid === currentUser.uid) {
                        updateDoc(userRef, { role: 'admin' });
                        showNotification("<i class='fa-solid fa-crown mr-2 text-yellow-500'></i> ТЕПЕРЬ ТЫ БАТЯ!");
                    }
                }

                users.forEach(u => {
                    const el = document.createElement('div');
                    el.className = "flex items-center gap-3 p-2 hover:bg-white/5 rounded-xl cursor-pointer sidebar-item justify-between";
                    let roleBadge = u.role === 'admin' ? '<i class="fa-solid fa-crown admin-crown ml-1"></i>' : '';
                    let roleName = u.role === 'admin' ? 'БАТЯ' : 'ЗРИТЕЛЬ';
                    let muteBtn = '';

                    if (myRole === 'admin' && u.uid !== currentUser.uid) {
                        const icon = u.mutedByAdmin ? 'fa-microphone-slash text-red-400' : 'fa-microphone text-white/20 hover:text-white';
                        muteBtn = `<button class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center transition" onclick="toggleMuteUser('${u.uid}', ${!u.mutedByAdmin})"><i class="fa-solid ${icon}"></i></button>`;
                    } else if (u.mutedByAdmin) {
                        muteBtn = `<span class="text-red-500/50 text-xs"><i class="fa-solid fa-microphone-slash"></i></span>`;
                    }

                    el.innerHTML = `
                        <div class="flex items-center gap-3">
                            <img src="${u.photoURL}" class="w-8 h-8 rounded-full bg-white/10">
                            <div class="flex flex-col">
                                <span class="text-xs font-bold">${u.displayName} ${roleBadge}</span>
                                <span class="text-[9px] text-white/40 uppercase font-bold tracking-wider">${roleName}</span>
                            </div>
                        </div>
                        ${muteBtn}
                    `;
                    list.appendChild(el);
                });
                if (users.length > 0) get('badge-users').classList.remove('hidden');
            });

            get('screen-lobby').classList.add('force-hidden');
            get('screen-app').classList.remove('force-hidden');
            heartbeatInterval = setInterval(() => { setDoc(userRef, { lastActive: serverTimestamp() }, { merge: true }); }, 30000);
        }

        window.toggleMuteUser = (targetUid, newState) => {
            if (myRole !== 'admin') return;
            updateDoc(doc(db, 'artifacts', APP_ID, 'rooms', currentRoomId, 'presence', targetUid), { mutedByAdmin: newState });
        }

        function muteMyMic(isMuted) {
            const btn = get('btn-toggle-voice');
            if (isMuted) {
                btn.classList.add('disabled');
                btn.innerHTML = '<i class="fa-solid fa-microphone-slash text-red-500"></i>';
            } else {
                btn.classList.remove('disabled');
                btn.innerHTML = '<i class="fa-solid fa-microphone-slash"></i>';
            }
        }

        get('tab-chat').onclick = () => {
            get('tab-chat').classList.replace('bg-white/5', 'text-white'); get('tab-chat').classList.remove('text-white/40');
            get('tab-users').classList.add('text-white/40'); get('tab-users').classList.remove('bg-white/5');
            get('view-chat').classList.remove('hidden'); get('view-users').classList.add('hidden');
        };
        get('tab-users').onclick = () => {
            get('tab-users').classList.replace('text-white/40', 'bg-white/5'); get('tab-users').classList.add('text-white');
            get('tab-chat').classList.add('text-white/40'); get('tab-chat').classList.remove('bg-white/5');
            get('view-users').classList.remove('hidden'); get('view-chat').classList.add('hidden');
        };

        get('btn-toggle-sidebar').onclick = () => get('sidebar').classList.toggle('active');

        get('form-chat').onsubmit = (e) => {
            e.preventDefault();
            const input = get('input-chat');
            const text = input.value.trim();
            if (!text || !currentRoomId) return;
            addDoc(collection(db, 'artifacts', APP_ID, 'rooms', currentRoomId, 'messages'), {
                text, user: currentUser.displayName, uid: currentUser.uid, createdAt: serverTimestamp()
            });
            input.value = '';
        };

        let activeProvider = 'none';
        let ytPlayer = null;
        let isNativeMode = false;
        let allowGuests = false;

        // --- VIDEO PARSER ---
        get('btn-load-video').onclick = () => {
            if (myRole !== 'admin' && !allowGuests) {
                showNotification("<i class='fa-solid fa-lock mr-2'></i> Только Батя может ставить видео");
                return;
            }
            const url = get('input-video-url').value.trim();
            if (!url) return;

            let provider = 'yt', videoId = '';
            
            // VK CHECK
            const vkRegex = /video(-?\d+)_(\d+)/;
            const vkMatch = url.match(vkRegex);
            
            if (vkMatch) {
                provider = 'vk'; 
                videoId = `https://vk.com/video_ext.php?oid=${vkMatch[1]}&id=${vkMatch[2]}&hd=2&autoplay=1`;
            } else if (url.includes('vk.com/video_ext.php')) {
                provider = 'vk'; 
                videoId = url;
            } else {
                // YOUTUBE
                const ytRegExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
                const ytMatch = url.match(ytRegExp);
                
                if (ytMatch && ytMatch[2].length === 11) {
                    provider = 'yt';
                    videoId = ytMatch[2];
                } else {
                    showNotification("Неверная ссылка YouTube");
                    return;
                }
            }

            setDoc(doc(db, 'artifacts', APP_ID, 'rooms', currentRoomId), {
                provider, videoId, status: 'playing', timestamp: 0, updatedAt: Date.now()
            }, { merge: true });
            get('input-video-url').value = '';
        };

        // --- SYNC ENGINE ---
        function syncState(d) {
            if (d.allowGuests !== undefined) {
                allowGuests = d.allowGuests;
                updatePermissionsUI();
            }
            if (d.videoId) get('player-placeholder').style.display = 'none';

            // Provider Switching
            if (d.provider !== activeProvider) {
                activeProvider = d.provider;
                document.querySelectorAll('#video-layer > div, #video-layer > video').forEach(el => {
                    if (el.id !== 'ios-kickstart' && el.id !== 'video-layer') el.classList.add('force-hidden');
                });

                if (d.provider === 'yt') get('player-yt').classList.remove('force-hidden');
                if (d.provider === 'vk') get('player-vk-container').classList.remove('force-hidden');
                if (d.provider === 'screen') {
                    get('player-stream').classList.remove('force-hidden');
                    connectToStream(d.streamPeerId);
                }

                // UI Mode for provider
                if (d.provider !== 'yt') {
                    get('timeline-container').style.opacity = '0.5'; get('timeline-container').style.pointerEvents = 'none';
                } else {
                    get('timeline-container').style.opacity = '1'; get('timeline-container').style.pointerEvents = 'auto';
                }
            }

            // VK HANDLING
            if (d.provider === 'vk') {
                const f = get('player-vk-container');
                if (!f.querySelector('iframe') || f.querySelector('iframe').src !== d.videoId) {
                    f.innerHTML = `<iframe src="${d.videoId}" allow="autoplay; fullscreen" frameborder="0"></iframe>`;
                }
            }

            // YOUTUBE SYNC LOGIC (ROBUST FOR IOS)
            if (d.provider === 'yt' && ytPlayer && ytPlayer.loadVideoById) {
                try {
                    const playerState = ytPlayer.getPlayerState();
                    const currentVid = ytPlayer.getVideoData() ? ytPlayer.getVideoData().video_id : null;
                    
                    // 1. Load correct video
                    if (currentVid !== d.videoId) {
                        console.log("Loading new video:", d.videoId);
                        ytPlayer.loadVideoById({videoId: d.videoId});
                        return; // Wait for next tick
                    }

                    // 2. Sync Time (Smart)
                    // Only seek if difference is significant to prevent stuttering
                    const myTime = ytPlayer.getCurrentTime();
                    const diff = Math.abs(myTime - d.timestamp);
                    const tolerance = 1.5; // Seconds

                    if (diff > tolerance) {
                        ytPlayer.seekTo(d.timestamp);
                    }

                    // 3. Sync State (Play/Pause)
                    if (d.status === 'playing') {
                        if (playerState !== 1 && playerState !== 3) { // 3 is buffering
                            ytPlayer.playVideo();
                        }
                        // iOS Fix: Если мы должны играть, но плеер "завис" в unstarted ( -1 ) или cued ( 5 ), показываем кнопку
                        if (playerState === -1 || playerState === 5 || playerState === 2) {
                             // Check if interaction needed
                             // We don't force show here to avoid flickering, but the button is available via 'ios-kickstart'
                        }
                    } else {
                        if (playerState === 1) ytPlayer.pauseVideo();
                    }
                    
                    // UPDATE UI
                    updateStatusUI(d.status);

                } catch (e) {
                    console.warn("YouTube Sync Error (Ignored for iOS stability):", e);
                }
            }
        }

        function updateStatusUI(status) {
            if (status === 'playing') {
                get('btn-play-pause').innerHTML = '<i class="fa-solid fa-pause"></i>';
                get('status-text').innerText = "PLAYING";
                get('status-dot').className = "w-2 h-2 bg-green-500 rounded-full animate-pulse";
                get('ios-kickstart').classList.add('force-hidden'); // Hide kickstarter if playing
            } else {
                get('btn-play-pause').innerHTML = '<i class="fa-solid fa-play"></i>';
                get('status-text').innerText = "PAUSED";
                get('status-dot').className = "w-2 h-2 bg-yellow-500 rounded-full";
            }
        }

        // --- IOS KICKSTART LOGIC ---
        // This is the magic fix for iOS. User must tap to start.
        get('ios-kickstart').onclick = () => {
            if (ytPlayer && ytPlayer.playVideo) {
                ytPlayer.playVideo();
                get('ios-kickstart').classList.add('force-hidden');
            }
        }

        // --- YOUTUBE API SETUP ---
        if (!window.YT) { const t = document.createElement('script'); t.src = "https://www.youtube.com/iframe_api"; document.body.appendChild(t); }
        
        window.onYouTubeIframeAPIReady = () => {
            const origin = window.location.origin || 'https://www.youtube.com'; // Safe Fallback
            
            ytPlayer = new YT.Player('player-yt', {
                height: '100%', 
                width: '100%',
                videoId: '', // Start empty
                host: 'https://www.youtube.com', 
                playerVars: { 
                    'controls': 0, // Disable YT controls to force custom UI (prevents conflict)
                    'disablekb': 1,
                    'fs': 0,
                    'rel': 0, 
                    'origin': origin,
                    'widget_referrer': origin,
                    'autoplay': 1, // Tries to autoplay
                    'mute': 0, // Unmuted by default (iOS might force mute)
                    'playsinline': 1, // CRITICAL FOR IOS
                    'enablejsapi': 1,
                    'iv_load_policy': 3
                },
                events: {
                    'onReady': (e) => {
                         console.log("YT Ready");
                         if (activeProvider === 'yt') e.target.playVideo();
                    },
                    'onStateChange': (e) => {
                        // iOS State Handling
                        // -1: unstarted, 0: ended, 1: playing, 2: paused, 3: buffering, 5: cued
                        
                        // If Unstarted (-1) and supposed to be playing -> Show Kickstart
                        if (e.data === -1 || e.data === 5) {
                             // Check DB state? Maybe later. For now assume user needs to tap if it doesn't start.
                             // We only show kickstart if we receive a "playing" signal from DB but player is stuck.
                        }

                        if (!currentRoomId || isNativeMode) return;
                        if (myRole !== 'admin' && !allowGuests) return;

                        if (e.data === 1 || e.data === 2) {
                            // Debounce state updates to DB
                            // Only update if we are the one triggering the change (basic check)
                            // Ideally, we trust the Admin's state. 
                            
                            // NOTE: Removing the auto-update from state change for "Viewers" reduces loop issues.
                            if (myRole === 'admin' || allowGuests) {
                                setDoc(doc(db, 'artifacts', APP_ID, 'rooms', currentRoomId), {
                                    status: e.data === 1 ? 'playing' : 'paused',
                                    timestamp: ytPlayer.getCurrentTime()
                                }, { merge: true });
                            }
                        }
                    },
                    'onError': (e) => {
                        console.error("YT Error:", e.data);
                        if (e.data === 150 || e.data === 101) {
                             showNotification("<i class='fa-solid fa-ban text-red-500 mr-2'></i> Видео недоступно для встраивания");
                        }
                    }
                }
            });

            // UI UPDATER LOOP (With Try-Catch for iOS safety)
            setInterval(() => {
                if (!ytPlayer || !ytPlayer.getCurrentTime) return;
                
                try {
                    // Check if player is alive
                    if (ytPlayer.getIframe() && activeProvider === 'yt') {
                        const t = ytPlayer.getCurrentTime();
                        const d = ytPlayer.getDuration();
                        
                        if (t && d) {
                            get('time-current').innerText = formatTime(t);
                            get('time-duration').innerText = formatTime(d);
                            get('seek-bar').value = (t / d) * 100 || 0;
                        }

                        // iOS Kickstart Visibility Check
                        // If DB says playing, but Player says Paused/Unstarted, show big button
                        const state = ytPlayer.getPlayerState();
                        const statusText = get('status-text').innerText;
                        
                        if (statusText === 'PLAYING' && (state === 2 || state === -1 || state === 5)) {
                            get('ios-kickstart').classList.remove('force-hidden');
                        } else {
                            get('ios-kickstart').classList.add('force-hidden');
                        }
                    }
                } catch (e) {
                    // Silent catch to prevent UI freeze
                }
            }, 1000);
        };

        window.togglePlay = () => {
            if (myRole !== 'admin' && !allowGuests) {
                showNotification("<i class='fa-solid fa-lock mr-2'></i> Пауза доступна только Бате");
                return;
            }
            if (activeProvider === 'yt' && ytPlayer) {
                try {
                    const s = ytPlayer.getPlayerState();
                    const newState = (s === 1) ? 'paused' : 'playing';
                    
                    setDoc(doc(db, 'artifacts', APP_ID, 'rooms', currentRoomId), {
                        status: newState,
                        timestamp: ytPlayer.getCurrentTime()
                    }, { merge: true });
                } catch(e) {}
            }
        };

        get('seek-bar').oninput = (e) => {
            if (myRole !== 'admin' && !allowGuests) {
                showNotification("<i class='fa-solid fa-lock mr-2'></i> Перемотка только для Бати");
                return;
            }
            if (activeProvider === 'yt' && ytPlayer) {
                try {
                    const time = (e.target.value / 100) * ytPlayer.getDuration();
                    ytPlayer.seekTo(time);
                    setDoc(doc(db, 'artifacts', APP_ID, 'rooms', currentRoomId), { timestamp: time }, { merge: true });
                } catch(e) {}
            }
        };

        window.toggleNativeMode = () => {
            document.body.classList.toggle('native-mode');
            isNativeMode = document.body.classList.contains('native-mode');
            if (ytPlayer && ytPlayer.getIframe) {
                // On iOS native mode, we might want to bring back controls
                // But replacing vars requires reloading. 
                // For now, just unblocking the overlay allows native controls to work if present.
            }
            showNotification(isNativeMode ? "Режим Native: Кликайте по видео!" : "UI восстановлен");
        };

        window.toggleGuestPermissions = () => {
            if (myRole !== 'admin') return;
            const newState = !allowGuests;
            setDoc(doc(db, 'artifacts', APP_ID, 'rooms', currentRoomId), { allowGuests: newState }, { merge: true });
            showNotification(newState ? "<i class='fa-solid fa-lock-open mr-2'></i> Гостям разрешено управление" : "<i class='fa-solid fa-lock mr-2'></i> Управление только у Бати");
        };

        function updatePermissionsUI() {
            const btn = get('btn-toggle-permissions');
            if (myRole === 'admin') {
                btn.classList.remove('hidden');
                if (allowGuests) {
                    btn.innerHTML = '<i class="fa-solid fa-lock-open text-green-400"></i>';
                    btn.classList.add('text-green-400');
                    btn.classList.remove('text-white/30');
                } else {
                    btn.innerHTML = '<i class="fa-solid fa-lock"></i>';
                    btn.classList.remove('text-green-400');
                    btn.classList.add('text-white/30');
                }
            } else {
                btn.classList.add('hidden');
            }
        }

        let peer = null;
        get('btn-screen-share').onclick = () => {
            if (!peer) peer = new Peer();
            peer.on('open', (id) => {
                navigator.mediaDevices.getDisplayMedia({ video: true, audio: true }).then(stream => {
                    const video = get('player-stream');
                    video.srcObject = stream;
                    video.classList.remove('force-hidden');
                    setDoc(doc(db, 'artifacts', APP_ID, 'rooms', currentRoomId), {
                        provider: 'screen', streamPeerId: id, status: 'playing'
                    }, { merge: true });
                    peer.on('call', call => call.answer(stream));
                });
            });
        };

        function connectToStream(hostId) {
            if (!hostId || !get('player-stream').classList.contains('force-hidden')) return;
            if (!peer) peer = new Peer();
            peer.on('open', () => {
                const call = peer.call(hostId, new MediaStream());
                call.on('stream', remoteStream => {
                    get('player-stream').srcObject = remoteStream;
                    get('player-stream').play();
                });
            });
        }
    </script>
</body>

</html>
