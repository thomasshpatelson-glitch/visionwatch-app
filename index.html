<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Co-Watch Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #050505; color: #e5e5e5; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        .min-input {
            background: #111;
            border: 1px solid #333;
            color: white;
            transition: all 0.2s;
        }
        .min-input:focus {
            border-color: #666;
            outline: none;
            background: #1a1a1a;
        }

        .glass {
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(10px);
        }

        /* Анимация перехода экранов */
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-200">

    <!-- 1. AUTH SCREEN -->
    <div id="screen-auth" class="fixed inset-0 z-50 flex items-center justify-center glass fade-in">
        <div class="bg-black border border-gray-800 p-8 rounded-xl max-w-sm w-full shadow-2xl text-center">
            <i class="fa-brands fa-youtube text-5xl mb-4 text-white"></i>
            <h1 class="text-2xl font-bold mb-1">Co-Watch</h1>
            <p class="text-gray-500 text-sm mb-8">Смотрите видео вместе</p>

            <button id="btn-google-login" class="w-full bg-white text-black font-bold py-3 px-4 rounded hover:bg-gray-200 transition flex items-center justify-center gap-3 mb-4">
                <i class="fa-brands fa-google"></i> Войти через Google
            </button>
            
            <div class="relative py-2 mb-4">
                <div class="absolute inset-0 flex items-center"><span class="w-full border-t border-gray-800"></span></div>
                <div class="relative flex justify-center text-xs uppercase"><span class="bg-black px-2 text-gray-500">или</span></div>
            </div>

            <button id="btn-guest-login" class="w-full bg-gray-900 text-gray-300 font-medium py-3 px-4 rounded hover:bg-gray-800 transition border border-gray-800">
                Войти как Гость
            </button>
        </div>
    </div>

    <!-- 2. LOBBY SCREEN (Create/Join Room) -->
    <div id="screen-lobby" class="fixed inset-0 z-40 flex items-center justify-center bg-[#050505] hidden">
        <div class="w-full max-w-md p-6 fade-in">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-gray-900 rounded-full mx-auto mb-4 flex items-center justify-center border border-gray-800">
                    <img id="lobby-avatar" src="" class="w-full h-full rounded-full object-cover p-1">
                </div>
                <h2 class="text-xl font-bold">Привет, <span id="lobby-username" class="text-white">...</span></h2>
                <p class="text-sm text-gray-500 mt-1">Куда отправимся?</p>
            </div>

            <div class="bg-black border border-gray-800 rounded-xl p-6 space-y-6">
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 block">Создать комнату</label>
                    <button id="btn-create-room" class="w-full bg-white text-black font-bold py-4 rounded hover:bg-gray-200 transition flex items-center justify-center gap-2">
                        <i class="fa-solid fa-plus"></i> Новая комната
                    </button>
                </div>

                <div class="relative flex py-2 items-center">
                    <div class="flex-grow border-t border-gray-800"></div>
                    <span class="flex-shrink mx-4 text-gray-600 text-xs uppercase">Вход по ID</span>
                    <div class="flex-grow border-t border-gray-800"></div>
                </div>

                <form id="form-join-room" class="flex gap-2">
                    <input type="text" id="input-room-id" placeholder="ID комнаты (например: 4812)" class="min-input flex-1 p-3 rounded font-mono text-center uppercase tracking-widest" required maxlength="6">
                    <button type="submit" class="bg-gray-800 text-white px-6 rounded hover:bg-gray-700 font-bold border border-gray-700">
                        <i class="fa-solid fa-arrow-right"></i>
                    </button>
                </form>
            </div>
            
            <button id="btn-logout" class="w-full text-center text-xs text-red-500 mt-8 hover:text-red-400">Выйти из аккаунта</button>
        </div>
    </div>

    <!-- 3. MAIN APP SCREEN -->
    <div id="screen-app" class="flex-1 flex flex-col md:flex-row h-full hidden">
        
        <!-- SIDEBAR: Users -->
        <div class="w-full md:w-64 bg-black border-r border-gray-800 flex flex-col hidden md:flex">
            <div class="p-4 border-b border-gray-800">
                <h1 class="font-bold text-lg tracking-tight">Co-Watch</h1>
                <div class="flex items-center gap-2 mt-1 cursor-pointer hover:text-white text-gray-500 text-xs" id="copy-room-id">
                    <span class="bg-gray-900 px-2 py-1 rounded border border-gray-800 font-mono" id="display-room-id">...</span>
                    <i class="fa-regular fa-copy"></i>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-2">
                <div class="text-xs font-bold text-gray-600 mb-2 px-2 mt-2">ОНЛАЙН</div>
                <div id="users-list" class="space-y-1"></div>
            </div>

            <!-- My Profile Mini -->
            <div class="p-4 border-t border-gray-800 bg-gray-900/20 hover:bg-gray-900/50 cursor-pointer transition" id="btn-open-profile">
                <div class="flex items-center gap-3">
                    <img id="app-user-avatar" src="" class="w-9 h-9 rounded bg-gray-800 border border-gray-700 object-cover">
                    <div class="overflow-hidden">
                        <p id="app-user-name" class="text-sm font-bold truncate text-white">...</p>
                        <p class="text-xs text-green-500 flex items-center gap-1"><span class="w-1.5 h-1.5 bg-green-500 rounded-full"></span> В сети</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- CENTER: Video Player -->
        <div class="flex-1 flex flex-col bg-[#050505] relative">
            <!-- Mobile Header -->
            <div class="md:hidden h-14 bg-black border-b border-gray-800 flex items-center justify-between px-4">
                <span class="font-bold">Co-Watch</span>
                <button id="btn-mobile-users" class="text-gray-400"><i class="fa-solid fa-users"></i></button>
            </div>

            <!-- Search Bar -->
            <div class="p-4 border-b border-gray-800 flex gap-2 bg-black/50 backdrop-blur-sm absolute top-0 left-0 right-0 z-10 transition-transform duration-300" id="video-controls">
                <div class="flex-1 relative">
                    <i class="fa-brands fa-youtube absolute left-3 top-3 text-gray-500"></i>
                    <input type="text" id="input-video-url" placeholder="Вставьте ссылку на YouTube" class="min-input w-full pl-10 pr-4 py-2 rounded text-sm">
                </div>
                <button id="btn-load-video" class="bg-white text-black px-4 py-2 rounded font-bold text-sm hover:bg-gray-200">
                    <i class="fa-solid fa-play"></i>
                </button>
            </div>

            <!-- Player Area -->
            <div class="flex-1 flex items-center justify-center bg-black relative w-full h-full">
                <div id="player-placeholder" class="text-center text-gray-700">
                    <i class="fa-brands fa-youtube text-7xl mb-4 opacity-20"></i>
                    <p class="text-sm font-mono">ROOM ID: <span id="placeholder-room-id">...</span></p>
                    <p class="text-xs mt-2 opacity-50">Вставьте ссылку сверху, чтобы начать</p>
                </div>
                <div id="player" class="w-full h-full absolute inset-0 hidden"></div>
            </div>
        </div>

        <!-- RIGHT: Chat -->
        <div class="w-full md:w-80 bg-black border-l border-gray-800 flex flex-col h-[35vh] md:h-auto">
            <div class="p-3 border-b border-gray-800 bg-black flex justify-between items-center">
                <span class="font-bold text-sm text-gray-400">ЧАТ КОМНАТЫ</span>
                <button id="btn-leave-room" class="text-xs text-red-900 hover:text-red-500 transition px-2 py-1 rounded border border-transparent hover:border-red-900/50">
                    <i class="fa-solid fa-arrow-right-from-bracket"></i>
                </button>
            </div>
            
            <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 bg-[#080808]">
                <!-- Messages go here -->
            </div>

            <form id="form-chat" class="p-3 border-t border-gray-800 bg-black flex gap-2">
                <input type="text" id="input-message" placeholder="Написать..." class="min-input flex-1 p-2 rounded text-sm bg-[#111]" autocomplete="off">
                <button type="submit" class="bg-gray-800 text-white w-10 h-10 rounded hover:bg-gray-700 transition flex items-center justify-center">
                    <i class="fa-solid fa-paper-plane text-xs"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- MODAL: Profile Settings -->
    <div id="modal-profile" class="fixed inset-0 z-50 flex items-center justify-center bg-black/90 hidden">
        <div class="bg-[#111] border border-gray-700 p-6 rounded-xl w-full max-w-sm relative">
            <button id="btn-close-profile" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
            <h3 class="text-lg font-bold mb-6 text-center">Редактировать профиль</h3>
            
            <form id="form-profile" class="space-y-5">
                <div class="flex justify-center">
                    <div class="relative group cursor-pointer" id="avatar-trigger">
                        <img id="edit-avatar-preview" src="" class="w-24 h-24 rounded-full border-2 border-gray-600 object-cover">
                        <div class="absolute inset-0 bg-black/60 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                            <i class="fa-solid fa-dice text-2xl text-white"></i>
                        </div>
                    </div>
                </div>
                <p class="text-center text-xs text-gray-500">Нажми на аватар, чтобы сгенерировать новый</p>
                
                <div>
                    <label class="text-xs text-gray-500 uppercase font-bold mb-1 block">Имя</label>
                    <input type="text" id="edit-name" class="min-input w-full p-3 rounded" required minlength="2">
                </div>

                <button type="submit" class="w-full bg-white text-black font-bold py-3 rounded hover:bg-gray-200 transition">Сохранить</button>
            </form>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 bg-white text-black px-6 py-3 rounded-full shadow-2xl text-sm font-bold transform -translate-y-20 transition-transform duration-300 z-[100] flex items-center gap-2">
        <i class="fa-solid fa-circle-info text-blue-600"></i>
        <span id="toast-msg">Notification</span>
    </div>

    <!-- FIREBASE LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInAnonymously, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, addDoc, query, orderBy, limit, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyBrm8hgy9L0FFL_7CdLnR6jxyoLqy94AQA",
            authDomain: "upbeat-orb-479013-p8.firebaseapp.com",
            projectId: "upbeat-orb-479013-p8",
            storageBucket: "upbeat-orb-479013-p8.firebasestorage.app",
            messagingSenderId: "547138498300",
            appId: "1:547138498300:web:a03c11d6aafd5f027cf179"
        };
        
        const APP_ID = 'cw-pro-v1'; // Namespace for this app version
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // STATE
        let currentUser = null;
        let currentRoomId = null;
        let unsubscribeRoom = null;
        let unsubscribeChat = null;
        let unsubscribeUsers = null;
        let player = null;
        let isPlayerReady = false;
        let usersCache = {};
        
        // DOM ELEMENTS
        const screens = {
            auth: document.getElementById('screen-auth'),
            lobby: document.getElementById('screen-lobby'),
            app: document.getElementById('screen-app')
        };
        
        // --- AUTHENTICATION FLOW ---
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                initUserInDb(user).then(() => {
                    showScreen('lobby');
                    updateLobbyUI(user);
                });
            } else {
                currentUser = null;
                showScreen('auth');
            }
        });

        document.getElementById('btn-google-login').onclick = () => {
            signInWithPopup(auth, new GoogleAuthProvider()).catch(e => showToast(e.message));
        };

        document.getElementById('btn-guest-login').onclick = () => {
            const guestName = prompt("Как вас называть?", "Гость");
            if(!guestName) return;
            signInAnonymously(auth).then(cred => {
                updateProfile(cred.user, { 
                    displayName: guestName,
                    photoURL: `https://api.dicebear.com/7.x/initials/svg?seed=${guestName}&backgroundColor=111`
                });
            }).catch(e => showToast(e.message));
        };

        document.getElementById('btn-logout').onclick = () => signOut(auth);

        async function initUserInDb(user) {
            const userRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', user.uid);
            await setDoc(userRef, {
                uid: user.uid,
                displayName: user.displayName || 'Anon',
                photoURL: user.photoURL,
                email: user.email || 'guest',
                lastSeen: serverTimestamp()
            }, { merge: true });
        }

        // --- LOBBY LOGIC ---

        function updateLobbyUI(user) {
            document.getElementById('lobby-username').textContent = user.displayName;
            document.getElementById('lobby-avatar').src = user.photoURL;
        }

        document.getElementById('btn-create-room').onclick = () => {
            const newRoomId = Math.random().toString(36).substring(2, 8).toUpperCase();
            enterRoom(newRoomId);
        };

        document.getElementById('form-join-room').onsubmit = (e) => {
            e.preventDefault();
            const id = document.getElementById('input-room-id').value.trim().toUpperCase();
            if(id.length < 3) return showToast("Слишком короткий ID");
            enterRoom(id);
        };

        async function enterRoom(roomId) {
            currentRoomId = roomId;
            
            // 1. Update Room DB Entry (Create if needed)
            const roomRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'rooms', roomId);
            // We just ensure it exists or update last accessed
            await setDoc(roomRef, { active: true }, { merge: true });

            // 2. Add user to room's active user list (Virtual concept, handled via presence)
            // For simplicity in this structure, we just update local state and listeners
            
            document.getElementById('display-room-id').textContent = roomId;
            document.getElementById('placeholder-room-id').textContent = roomId;
            
            showScreen('app');
            initRoomListeners(roomId);
            showToast(`Вход в комнату: ${roomId}`);
        }

        document.getElementById('btn-leave-room').onclick = () => {
            if(unsubscribeRoom) unsubscribeRoom();
            if(unsubscribeChat) unsubscribeChat();
            if(unsubscribeUsers) unsubscribeUsers(); // In a real app we'd scope users by room
            
            if(player && player.stopVideo) player.stopVideo();
            document.getElementById('player').classList.add('hidden');
            document.getElementById('player-placeholder').classList.remove('hidden');
            
            showScreen('lobby');
            currentRoomId = null;
        };

        // --- MAIN APP LOGIC ---

        function initRoomListeners(roomId) {
            // 1. SYNC VIDEO
            const roomRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'rooms', roomId);
            unsubscribeRoom = onSnapshot(roomRef, (snap) => {
                if(!snap.exists()) return;
                const data = snap.data();
                syncPlayer(data);
            });

            // 2. CHAT (Using a specific collection for this room to follow constraints)
            // We use a collection named `messages_${roomId}` to keep data isolated flatly
            const chatColId = `messages_${roomId}`; 
            const chatRef = collection(db, 'artifacts', APP_ID, 'public', 'data', chatColId);
            const q = query(chatRef, orderBy('timestamp', 'asc'), limit(100));
            
            const chatContainer = document.getElementById('chat-container');
            chatContainer.innerHTML = ''; // Clear old

            unsubscribeChat = onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === "added") {
                        renderMessage(change.doc.data());
                    }
                });
                chatContainer.scrollTop = chatContainer.scrollHeight;
            });

            // 3. USERS (Global list for demo, or filter client side if we added roomId to user doc)
            // For this demo, we'll just show all online users in the system, 
            // but in production you'd add 'currentRoom' field to user doc.
            const usersRef = collection(db, 'artifacts', APP_ID, 'public', 'data', 'users');
            unsubscribeUsers = onSnapshot(usersRef, (snapshot) => {
                const list = document.getElementById('users-list');
                list.innerHTML = '';
                snapshot.forEach(doc => {
                    const u = doc.data();
                    usersCache[u.uid] = u; // Cache for chat avatars
                    
                    // Optional: Filter by room if we added that field. 
                    // For now showing all gives a sense of community or we can pretend.
                    
                    const isMe = u.uid === currentUser.uid;
                    const el = document.createElement('div');
                    el.className = `flex items-center gap-3 p-2 rounded hover:bg-gray-900 transition ${isMe ? 'bg-gray-900/50' : ''}`;
                    el.innerHTML = `
                        <img src="${u.photoURL}" class="w-8 h-8 rounded-full bg-gray-800 object-cover border border-gray-800">
                        <span class="text-sm font-medium ${isMe ? 'text-white' : 'text-gray-400'} truncate">${u.displayName}</span>
                    `;
                    list.appendChild(el);
                    
                    if(isMe) {
                        document.getElementById('app-user-name').textContent = u.displayName;
                        document.getElementById('app-user-avatar').src = u.photoURL;
                    }
                });
            });
        }

        // --- VIDEO PLAYER ---
        
        let lastServerTime = 0;
        let isSyncing = false;

        // Init Youtube API
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        document.body.appendChild(tag);

        window.onYouTubeIframeAPIReady = () => {
            player = new YT.Player('player', {
                height: '100%',
                width: '100%',
                playerVars: { 'playsinline': 1, 'controls': 1, 'rel': 0, 'modestbranding': 1 },
                events: {
                    'onReady': (e) => { isPlayerReady = true; },
                    'onStateChange': onPlayerStateChange
                }
            });
        };

        function onPlayerStateChange(event) {
            if(isSyncing || !currentRoomId) return;
            
            // Only sync Play (1) and Pause (2)
            // We debounce to prevent loops
            const state = event.data;
            if(state === YT.PlayerState.PLAYING || state === YT.PlayerState.PAUSED) {
                const status = state === YT.PlayerState.PLAYING ? 'playing' : 'paused';
                const time = player.getCurrentTime();
                
                // Update Firestore
                updateRoomState({
                    status: status,
                    timestamp: time,
                    videoId: player.getVideoData().video_id,
                    lastUpdated: Date.now()
                });
            }
        }

        async function updateRoomState(data) {
            const roomRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'rooms', currentRoomId);
            await setDoc(roomRef, data, { merge: true });
        }

        function syncPlayer(data) {
            if(!data.videoId || !player || !isPlayerReady) return;

            // Load new video
            const currentVid = player.getVideoData() ? player.getVideoData().video_id : null;
            if(currentVid !== data.videoId) {
                player.loadVideoById(data.videoId);
                document.getElementById('player').classList.remove('hidden');
                document.getElementById('player-placeholder').classList.add('hidden');
            }

            // Sync Time & State
            // Ignore updates if they are old or if we just sent them
            if(Math.abs(Date.now() - data.lastUpdated) > 5000 && data.status === 'playing') {
                // If update is old, just let it play, don't jump back
            }
            
            const diff = Math.abs(player.getCurrentTime() - data.timestamp);
            if(diff > 2) {
                isSyncing = true;
                player.seekTo(data.timestamp);
                setTimeout(() => isSyncing = false, 1000);
            }

            const pState = player.getPlayerState();
            if(data.status === 'paused' && pState !== YT.PlayerState.PAUSED) {
                isSyncing = true;
                player.pauseVideo();
                setTimeout(() => isSyncing = false, 500);
            } else if(data.status === 'playing' && pState !== YT.PlayerState.PLAYING) {
                isSyncing = true;
                player.playVideo();
                setTimeout(() => isSyncing = false, 500);
            }
        }

        document.getElementById('btn-load-video').onclick = () => {
            const url = document.getElementById('input-video-url').value;
            const vidId = extractVideoId(url);
            if(vidId && currentRoomId) {
                updateRoomState({
                    videoId: vidId,
                    status: 'playing',
                    timestamp: 0,
                    lastUpdated: Date.now()
                });
                document.getElementById('input-video-url').value = '';
            } else {
                showToast("Некорректная ссылка");
            }
        };

        function extractVideoId(url) {
            const m = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);
            return (m && m[2].length === 11) ? m[2] : null;
        }

        // --- CHAT & UTILS ---

        document.getElementById('form-chat').onsubmit = async (e) => {
            e.preventDefault();
            const input = document.getElementById('input-message');
            const txt = input.value.trim();
            if(!txt || !currentRoomId) return;

            const chatColId = `messages_${currentRoomId}`;
            await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', chatColId), {
                text: txt,
                senderId: currentUser.uid,
                timestamp: serverTimestamp()
            });
            input.value = '';
        };

        function renderMessage(msg) {
            const isMe = msg.senderId === currentUser.uid;
            const sender = usersCache[msg.senderId] || { displayName: '...', photoURL: 'https://via.placeholder.com/30' };
            
            const div = document.createElement('div');
            div.className = `flex gap-3 mb-4 ${isMe ? 'flex-row-reverse' : ''}`;
            div.innerHTML = `
                <img src="${sender.photoURL}" class="w-8 h-8 rounded-full bg-gray-800 flex-shrink-0 mt-1">
                <div class="max-w-[75%]">
                    <div class="text-[10px] text-gray-500 mb-1 ${isMe ? 'text-right' : ''}">${sender.displayName}</div>
                    <div class="px-3 py-2 rounded-lg text-sm ${isMe ? 'bg-white text-black' : 'bg-gray-800 text-gray-200'}">
                        ${msg.text}
                    </div>
                </div>
            `;
            document.getElementById('chat-container').appendChild(div);
        }

        // --- PROFILE EDIT ---

        document.getElementById('btn-open-profile').onclick = () => {
            document.getElementById('modal-profile').classList.remove('hidden');
            document.getElementById('edit-name').value = currentUser.displayName;
            document.getElementById('edit-avatar-preview').src = currentUser.photoURL;
        };

        document.getElementById('btn-close-profile').onclick = () => {
            document.getElementById('modal-profile').classList.add('hidden');
        };

        document.getElementById('avatar-trigger').onclick = () => {
            const seed = Math.random().toString(36);
            document.getElementById('edit-avatar-preview').src = `https://api.dicebear.com/7.x/initials/svg?seed=${seed}&backgroundColor=111`;
        };

        document.getElementById('form-profile').onsubmit = async (e) => {
            e.preventDefault();
            const newName = document.getElementById('edit-name').value;
            const newPic = document.getElementById('edit-avatar-preview').src;
            
            try {
                await updateProfile(currentUser, { displayName: newName, photoURL: newPic });
                await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', currentUser.uid), {
                    displayName: newName,
                    photoURL: newPic
                });
                updateLobbyUI(currentUser);
                document.getElementById('modal-profile').classList.add('hidden');
                showToast("Профиль сохранен");
            } catch(err) {
                showToast(err.message);
            }
        };

        // --- SYSTEM ---

        function showScreen(name) {
            Object.values(screens).forEach(s => s.classList.add('hidden'));
            screens[name].classList.remove('hidden');
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').textContent = msg;
            t.classList.remove('-translate-y-20');
            setTimeout(() => t.classList.add('-translate-y-20'), 3000);
        }

        document.getElementById('copy-room-id').onclick = () => {
            navigator.clipboard.writeText(currentRoomId);
            showToast("ID скопирован");
        };

    </script>
</body>
</html>
