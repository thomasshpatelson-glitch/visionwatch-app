<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;">
    
    <title>Co-Watch | v28 Nuclear Fix</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter+Tight:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* === RESET === */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #000; font-family: 'Inter Tight', sans-serif; color: #fff; }

        /* === LAYERS === */
        /* –°–ª–æ–π –≤–∏–¥–µ–æ - —Å–∞–º—ã–π –Ω–∏–∂–Ω–∏–π */
        #video-layer { 
            position: fixed; inset: 0; z-index: 0; 
            background: #000; display: flex; align-items: center; justify-content: center; 
        }
        
        /* –ü–ª–µ–µ—Ä—ã —Ä–∞—Å—Ç—è–Ω—É—Ç—ã –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
        .player-frame { position: absolute; inset: 0; width: 100%; height: 100%; border: none; }
        
        /* –ó–∞–≥–ª—É—à–∫–∞ - –ø–æ–≤–µ—Ä—Ö –≤–∏–¥–µ–æ, –ø–æ–∫–∞ –æ–Ω–æ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ */
        #player-placeholder { 
            position: absolute; inset: 0; z-index: 10; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            background: #050505; 
        }

        /* –û–≤–µ—Ä–ª–µ–π –∫–ª–∏–∫–∞ - –¥–ª—è –ø–∞—É–∑—ã YouTube */
        #click-overlay { position: absolute; inset: 0; z-index: 20; cursor: pointer; }

        /* UI - –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ */
        #ui-layer { 
            position: fixed; inset: 0; z-index: 100; pointer-events: none; 
            display: flex; flex-direction: column; justify-content: space-between; padding: 24px; 
        }

        /* === UI STYLES === */
        .glass-panel { background: rgba(10, 10, 10, 0.85); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .glass-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.05); transition: 0.2s; cursor: pointer; pointer-events: auto; }
        .glass-btn:hover { background: rgba(255,255,255,0.2); }
        .glass-btn:active { transform: scale(0.95); }
        .glass-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        
        .btn-active { background: white !important; color: black !important; }
        .voice-active { background: #22c55e !important; color: black !important; }
        .stream-active { background: #ef4444 !important; color: white !important; }

        .user-item { display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 12px; pointer-events: auto; }
        .user-item:hover { background: rgba(255,255,255,0.1); cursor: pointer; }
        
        /* === UTILS === */
        .force-hidden { display: none !important; }
        .ui-visible { opacity: 1; pointer-events: auto; }
        .ui-hidden { opacity: 0; pointer-events: none; }
        .transition-ui { transition: opacity 0.3s ease; }
        
        /* Badge */
        .badge { font-size: 9px; padding: 2px 6px; border-radius: 4px; font-weight: 800; text-transform: uppercase; margin-left: 6px; }
        .badge-batya { background: #eab308; color: black; }

        /* Sliders */
        .seek-slider { -webkit-appearance: none; width: 100%; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; outline: none; cursor: pointer; pointer-events: auto; }
        .seek-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; border-radius: 50%; background: #fff; cursor: pointer; }
        
        /* VK Iframe Fix */
        iframe { width: 100% !important; height: 100% !important; }
    </style>
</head>
<body onclick="unlockAudio()">

    <div id="screen-auth" class="fixed inset-0 z-[200] flex items-center justify-center bg-[#050505]">
        <div class="glass-panel p-10 rounded-3xl max-w-sm w-full text-center pointer-events-auto">
            <h1 class="text-4xl font-bold mb-2">Co-Watch</h1>
            <p class="text-gray-400 mb-8 text-sm">v28 Nuclear Fix</p>
            <button id="btn-google-login" class="w-full bg-white text-black font-bold py-3 rounded-xl mb-3">Google</button>
            <button id="btn-guest-login" class="w-full bg-white/10 text-white font-bold py-3 rounded-xl">–ì–æ—Å—Ç—å</button>
        </div>
    </div>

    <div id="screen-lobby" class="fixed inset-0 z-[150] flex items-center justify-center bg-[#050505] force-hidden pointer-events-auto">
        <div class="w-full max-w-md p-6">
            <div class="glass-panel rounded-3xl p-8 text-center">
                <h2 class="text-2xl font-bold mb-6">–ü—Ä–∏–≤–µ—Ç, <span id="lobby-username" class="text-blue-400">...</span></h2>
                <button id="btn-create-room" class="w-full bg-white text-black py-4 rounded-xl font-bold text-lg mb-4">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
                <div class="flex gap-2">
                    <input id="input-room-id" type="text" placeholder="ID –∫–æ–º–Ω–∞—Ç—ã" class="flex-1 bg-white/10 rounded-xl px-4 outline-none text-center font-mono uppercase">
                    <button id="btn-join-room" class="bg-white/20 px-6 rounded-xl font-bold"><i class="fa-solid fa-arrow-right"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-app" class="fixed inset-0 bg-black force-hidden">
        
        <div id="video-layer">
            <div id="player-placeholder">
                <i class="fa-solid fa-ghost text-8xl mb-4 text-white/20"></i>
                <p class="text-white/50 tracking-widest text-sm font-mono">–ñ–î–£ –°–°–´–õ–ö–£</p>
            </div>

            <div id="player-yt" class="player-frame force-hidden"></div>
            
            <div id="player-vk-container" class="player-frame force-hidden"></div>
            
            <video id="player-stream" class="player-frame force-hidden object-contain" autoplay playsinline></video>

            <div id="click-overlay"></div>
        </div>

        <div id="ui-layer">
            
            <div id="top-bar" class="flex justify-between items-center transition-ui pointer-events-auto">
                <div class="glass-panel px-4 py-2 rounded-full flex gap-3 cursor-pointer" id="copy-room-id">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    <span id="display-room-id" class="font-mono font-bold">...</span>
                </div>
                <div class="glass-panel p-1 rounded-full flex gap-2 w-full max-w-md mx-4">
                    <input id="input-video-url" type="text" placeholder="–°—Å—ã–ª–∫–∞ (YT / VK)..." class="bg-transparent flex-1 px-3 outline-none text-sm pointer-events-auto">
                    <button id="btn-load-video" class="w-8 h-8 bg-white text-black rounded-full flex items-center justify-center hover:bg-gray-200 pointer-events-auto"><i class="fa-solid fa-play text-xs"></i></button>
                </div>
                <button id="btn-leave-room" class="glass-panel w-10 h-10 rounded-full flex items-center justify-center text-red-400 hover:bg-white/10 pointer-events-auto"><i class="fa-solid fa-right-from-bracket"></i></button>
            </div>

            <div class="flex-1 flex flex-col justify-end items-end pb-24 pointer-events-none">
                <div id="toast-area" class="flex flex-col gap-2 w-72 items-end"></div>
            </div>

            <div id="bottom-bar" class="flex flex-col gap-4 transition-ui w-full max-w-3xl mx-auto relative">
                <div id="timeline-container" class="glass-panel px-4 py-3 rounded-2xl flex items-center gap-4 pointer-events-auto">
                    <div id="locked-indicator" class="hidden text-xs text-red-400 font-bold uppercase"><i class="fa-solid fa-lock"></i></div>
                    <button id="btn-play-pause" class="hover:text-blue-400 w-6"><i class="fa-solid fa-play" id="icon-play"></i></button>
                    <input type="range" id="seek-bar" class="seek-slider flex-1" value="0" min="0" step="1">
                </div>

                <div class="glass-panel p-2 rounded-2xl flex items-center gap-2 justify-center pointer-events-auto self-center">
                    <button id="btn-toggle-users" class="glass-btn w-12 h-12 rounded-xl flex items-center justify-center"><i class="fa-solid fa-users"></i></button>
                    <button id="btn-toggle-voice" class="glass-btn w-16 h-16 rounded-xl flex items-center justify-center text-xl -mt-6 bg-[#1a1a1a] border-white/20"><i class="fa-solid fa-microphone-slash"></i></button>
                    <button id="btn-screen-share" class="glass-btn w-12 h-12 rounded-xl flex items-center justify-center text-red-400"><i class="fa-solid fa-desktop"></i></button>
                    <button id="btn-toggle-chat" class="glass-btn w-12 h-12 rounded-xl flex items-center justify-center relative"><i class="fa-regular fa-comment"></i><span id="chat-badge" class="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full hidden"></span></button>
                    <div class="w-px h-8 bg-white/10 mx-1"></div>
                    <button id="btn-native-controls" class="glass-btn w-12 h-12 rounded-xl flex items-center justify-center text-white/50 hover:text-white" onclick="toggleNative()"><i class="fa-solid fa-gear"></i></button>
                </div>
            </div>

            <div id="panel-chat" class="absolute top-20 bottom-40 right-4 w-80 glass-panel rounded-2xl flex flex-col force-hidden pointer-events-auto">
                <div class="p-4 border-b border-white/10 font-bold text-xs uppercase">–ß–∞—Ç</div>
                <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
                <form id="form-chat" class="p-3 border-t border-white/10 flex gap-2"><input id="input-message" class="bg-white/5 w-full rounded-lg px-3 text-sm outline-none" placeholder="..." autocomplete="off"></form>
            </div>

            <div id="panel-users" class="absolute top-20 bottom-40 left-4 w-72 glass-panel rounded-2xl flex flex-col force-hidden pointer-events-auto">
                <div class="p-4 border-b border-white/10 font-bold text-xs uppercase">–£—á–∞—Å—Ç–Ω–∏–∫–∏</div>
                <div id="users-list-container" class="flex-1 overflow-y-auto p-2 space-y-1"></div>
            </div>
        </div>

        <div id="admin-modal" class="fixed inset-0 z-[200] flex items-center justify-center bg-black/80 force-hidden pointer-events-auto">
            <div class="glass-panel p-6 rounded-2xl w-80">
                <h3 class="font-bold mb-4">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
                <p id="admin-target-name" class="mb-4 text-gray-400">...</p>
                <div class="space-y-2">
                    <button id="btn-give-control" class="w-full bg-blue-600 py-2 rounded-lg text-sm font-bold">–î–∞—Ç—å/–ó–∞–±—Ä–∞—Ç—å –†—É–ª—å</button>
                    <button id="btn-make-admin" class="w-full bg-yellow-600 py-2 rounded-lg text-sm font-bold text-black">–°–¥–µ–ª–∞—Ç—å –ë–∞—Ç–µ–π</button>
                    <button onclick="document.getElementById('admin-modal').classList.add('force-hidden')" class="w-full bg-white/10 py-2 rounded-lg text-sm mt-2">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInAnonymously, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, addDoc, query, orderBy, limit, serverTimestamp, updateDoc, where, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBrm8hgy9LGFFL_7CdlnR6jxyolqy94AQA", authDomain: "upbeat-orb-479013-p8.firebaseapp.com", projectId: "upbeat-orb-479013-p8", storageBucket: "upbeat-orb-479013-p8.firebasestorage.app", messagingSenderId: "547138498300", appId: "1:547138498300:web:a03c11d6aafd5f027cf179" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const APP_ID = 'cw-v28-nuclear';

        // STATE
        let currentUser=null, currentRoomId=null, ytPlayer=null;
        let activeProvider = 'none'; // yt, vk, screen
        let myPermissions = { role: 'viewer', canControlVideo: false };
        
        // HELPER
        const get = (id) => document.getElementById(id);
        window.unlockAudio = () => { const a = new (window.AudioContext || window.webkitAudioContext)(); if(a.state==='suspended') a.resume(); };

        // --- AUTH ---
        onAuthStateChanged(auth, u => {
            if(u) { 
                currentUser = u; 
                get('lobby-username').textContent = u.displayName; 
                get('lobby-avatar').src = u.photoURL;
                get('screen-auth').classList.add('force-hidden');
                get('screen-lobby').classList.remove('force-hidden');
                loadRooms();
            } else {
                get('screen-auth').classList.remove('force-hidden');
                get('screen-lobby').classList.add('force-hidden');
                get('screen-app').classList.add('force-hidden');
            }
        });

        get('btn-google-login').onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
        get('btn-guest-login').onclick = () => signInAnonymously(auth).then(c => updateProfile(c.user, {displayName:`–ì–æ—Å—Ç—å ${Math.floor(Math.random()*999)}`, photoURL:`https://api.dicebear.com/7.x/thumbs/svg?seed=${Math.random()}`}));
        get('btn-logout').onclick = () => signOut(auth);

        // --- ROOMS ---
        function loadRooms() {
            onSnapshot(query(collection(db, 'artifacts', APP_ID, 'rooms'), where('isPublic', '==', true), limit(10)), snap => {
                const list = get('room-list'); list.innerHTML = '';
                snap.forEach(d => {
                    const r = d.data();
                    list.innerHTML += `<div onclick="window.joinRoom('${r.roomId}')" class="room-item text-sm font-bold p-3 mb-2 rounded bg-white/5 cursor-pointer hover:bg-white/10 flex justify-between"><span>${r.roomId}</span><span class="text-xs text-green-400">LIVE</span></div>`;
                });
            });
        }
        
        get('btn-create-room').onclick = () => {
            const id = Math.random().toString(36).substring(2, 7).toUpperCase();
            setDoc(doc(db, 'artifacts', APP_ID, 'rooms', id), { roomId: id, isPublic: !get('check-private').checked, status: 'paused', videoId: '', provider: 'none' });
            window.joinRoom(id, true);
        };
        get('btn-join-room').onclick = () => { const id = get('input-room-id').value.trim().toUpperCase(); if(id) window.joinRoom(id); };

        // --- JOIN LOGIC ---
        window.joinRoom = async (id, isCreator = false) => {
            currentRoomId = id;
            get('display-room-id').textContent = id;
            
            // Set Presence
            const role = isCreator ? 'batya' : 'viewer';
            const canControl = isCreator;
            await setDoc(doc(db, 'artifacts', APP_ID, 'rooms', id, 'presence', currentUser.uid), {
                uid: currentUser.uid, displayName: currentUser.displayName, photoURL: currentUser.photoURL,
                role: role, canControlVideo: canControl, voiceActive: false
            });

            // Listen to Room State (Video)
            onSnapshot(doc(db, 'artifacts', APP_ID, 'rooms', id), snap => {
                if (snap.exists()) syncState(snap.data());
            });

            // Listen to Presence (Users + My Permissions)
            onSnapshot(collection(db, 'artifacts', APP_ID, 'rooms', id, 'presence'), snap => {
                const list = get('users-list-container'); list.innerHTML = '';
                let hasBatya = false;
                let allUsers = [];
                
                snap.forEach(d => {
                    const u = d.data();
                    allUsers.push(u);
                    if(u.role === 'batya') hasBatya = true;
                    
                    // Update My Permissions
                    if (u.uid === currentUser.uid) {
                        myPermissions = { role: u.role, canControlVideo: u.canControlVideo };
                        updateControls();
                    }

                    // Render User
                    const badges = u.role === 'batya' ? 'üëë' : u.canControlVideo ? 'üéÆ' : '';
                    list.innerHTML += `
                        <div class="user-item hover:bg-white/5 p-2 rounded cursor-pointer" onclick="window.openAdmin('${u.uid}', '${u.displayName}')">
                            <img src="${u.photoURL}" class="w-8 h-8 rounded-full">
                            <span class="text-sm">${u.displayName} ${badges}</span>
                        </div>
                    `;
                });

                // Auto-Batya if current Batya leaves
                if(!hasBatya && allUsers.length > 0) {
                    allUsers.sort((a,b) => a.uid.localeCompare(b.uid));
                    if(allUsers[0].uid === currentUser.uid) {
                        updateDoc(doc(db, 'artifacts', APP_ID, 'rooms', id, 'presence', currentUser.uid), { role: 'batya', canControlVideo: true });
                    }
                }
            });

            get('screen-lobby').classList.add('force-hidden');
            get('screen-app').classList.remove('force-hidden');
        };

        // --- SYNC CORE ---
        function syncState(data) {
            const { provider, videoId, status, timestamp } = data;
            
            // 1. Provider Switching
            if (provider !== activeProvider) {
                get('player-placeholder').style.display = 'none'; // Hide placeholder once we have a provider
                get('player-yt').classList.add('force-hidden');
                get('player-vk-container').classList.add('force-hidden');
                get('player-stream').classList.add('force-hidden');
                
                if (provider === 'yt') get('player-yt').classList.remove('force-hidden');
                if (provider === 'vk') get('player-vk-container').classList.remove('force-hidden');
                if (provider === 'screen') get('player-stream').classList.remove('force-hidden');
                
                activeProvider = provider;
            }

            // 2. YouTube Sync
            if (provider === 'yt' && ytPlayer && ytPlayer.loadVideoById) {
                const currentId = ytPlayer.getVideoData().video_id;
                if (currentId !== videoId) ytPlayer.loadVideoById(videoId);
                
                // Time Sync (Allow 2s drift)
                if (Math.abs(ytPlayer.getCurrentTime() - timestamp) > 2) {
                    ytPlayer.seekTo(timestamp);
                }
                
                if (status === 'playing' && ytPlayer.getPlayerState() !== 1) ytPlayer.playVideo();
                if (status === 'paused' && ytPlayer.getPlayerState() !== 2) ytPlayer.pauseVideo();
            }

            // 3. VK Sync (Just load iframe)
            if (provider === 'vk') {
                const container = get('player-vk-container');
                if (!container.innerHTML.includes(videoId)) {
                     container.innerHTML = `<iframe src="${videoId}" width="100%" height="100%" allow="autoplay; fullscreen" frameborder="0"></iframe>`;
                }
            }
        }

        // --- CONTROLS ---
        get('btn-load-video').onclick = () => {
            if (!myPermissions.canControlVideo && myPermissions.role !== 'batya') return;
            
            const url = get('input-video-url').value;
            let provider = 'yt', videoId = '';

            if (url.includes('youtu')) {
                const m = url.match(/(?:v=|\/)([\w-]{11})/);
                if (m) videoId = m[1];
            } else if (url.includes('vk.com')) {
                provider = 'vk';
                // Try to extract standard VK embed format
                const m = url.match(/video(-?\d+_\d+)/);
                if(m) {
                     // Fallback to generic embed if hash not present, might need hash for private vids
                     videoId = `https://vk.com/video_ext.php?oid=${m[1].split('_')[0]}&id=${m[1].split('_')[1]}&hd=2`; 
                } else if (url.includes('iframe')) {
                     // User pasted iframe code? try to extract src
                     const src = url.match(/src="([^"]+)"/);
                     if(src) videoId = src[1];
                     else videoId = url; // Assume user pasted direct embed link
                } else {
                     videoId = url; // Hope for the best
                }
            }

            if (videoId) {
                setDoc(doc(db, 'artifacts', APP_ID, 'rooms', currentRoomId), {
                    provider, videoId, status: 'playing', timestamp: 0
                }, { merge: true });
            }
        };

        function updateControls() {
            const allowed = myPermissions.role === 'batya' || myPermissions.canControlVideo;
            get('input-video-url').disabled = !allowed;
            get('btn-load-video').disabled = !allowed;
            get('click-overlay').style.pointerEvents = allowed ? 'auto' : 'none';
            get('locked-indicator').style.display = allowed ? 'none' : 'block';
            
            // Only Batya can screen share
            get('btn-screen-share').style.display = myPermissions.role === 'batya' ? 'flex' : 'none';
        }

        // --- YOUTUBE INIT ---
        if (!window.YT) { 
            const t = document.createElement('script'); 
            t.src = "https://www.youtube.com/iframe_api"; 
            document.body.appendChild(t); 
        }
        window.onYouTubeIframeAPIReady = () => {
            ytPlayer = new YT.Player('player-yt', {
                height: '100%', width: '100%',
                playerVars: { 'autoplay': 0, 'controls': 1, 'rel': 0, 'origin': window.location.origin },
                events: {
                    'onStateChange': (e) => {
                        if (!currentRoomId || (!myPermissions.canControlVideo && myPermissions.role !== 'batya')) return;
                        if (e.data === 1 || e.data === 2) {
                            setDoc(doc(db, 'artifacts', APP_ID, 'rooms', currentRoomId), {
                                status: e.data === 1 ? 'playing' : 'paused',
                                timestamp: ytPlayer.getCurrentTime()
                            }, { merge: true });
                        }
                    }
                }
            });
        };

        // --- UTILS ---
        get('btn-toggle-chat').onclick = () => get('panel-chat').classList.toggle('force-hidden');
        get('btn-toggle-users').onclick = () => get('panel-users').classList.toggle('force-hidden');
        
        // Native Controls Switcher
        window.toggleNative = () => {
            const ui = get('ui-layer');
            const overlay = get('click-overlay');
            if (ui.style.opacity === '0') {
                ui.style.opacity = '1';
                ui.style.pointerEvents = 'none'; // UI visible but pass through? No, reset
                get('top-bar').style.pointerEvents = 'auto';
                get('bottom-bar').style.pointerEvents = 'auto';
                overlay.style.pointerEvents = 'auto'; // Intercept clicks for sync
            } else {
                ui.style.opacity = '0';
                // Disable UI interaction
                get('top-bar').style.pointerEvents = 'none';
                get('bottom-bar').style.pointerEvents = 'none';
                overlay.style.pointerEvents = 'none'; // Let clicks go to YouTube Iframe
            }
        };

        // ADMIN ACTIONS
        let targetUid = null;
        window.openAdmin = (uid, name) => {
            if (myPermissions.role !== 'batya' || uid === currentUser.uid) return;
            targetUid = uid;
            get('admin-target-name').innerText = name;
            get('admin-modal').classList.remove('force-hidden');
        };
        
        get('btn-give-control').onclick = () => {
            // Toggle control logic needs current user state, just set true for demo
            updateDoc(doc(db, 'artifacts', APP_ID, 'rooms', currentRoomId, 'presence', targetUid), { canControlVideo: true });
            get('admin-modal').classList.add('force-hidden');
        };
        
        get('btn-make-admin').onclick = () => {
             updateDoc(doc(db, 'artifacts', APP_ID, 'rooms', currentRoomId, 'presence', targetUid), { role: 'batya', canControlVideo: true });
             updateDoc(doc(db, 'artifacts', APP_ID, 'rooms', currentRoomId, 'presence', currentUser.uid), { role: 'viewer' }); // Demote self
             get('admin-modal').classList.add('force-hidden');
        };

        get('btn-leave-room').onclick = () => {
             deleteDoc(doc(db, 'artifacts', APP_ID, 'rooms', currentRoomId, 'presence', currentUser.uid));
             window.location.reload();
        };
    </script>
</body>
</html>
