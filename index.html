<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;">
    <title>Co-Watch | Батя Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* CORE */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; scrollbar-width: none; outline: none; }
        ::-webkit-scrollbar { display: none; }
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #050505; font-family: 'Manrope', sans-serif; color: #fff; }

        /* Z-INDEX HIERARCHY */
        .layer-bg { z-index: 1; }
        .layer-video { z-index: 10; }
        .layer-overlay { z-index: 20; } /* Прозрачный слой для перехвата кликов */
        .layer-ui { z-index: 50; } /* Интерфейс */
        .layer-modal { z-index: 100; }
        
        /* GLASS UI */
        .glass-panel { 
            background: rgba(18, 18, 18, 0.9); 
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08); 
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }
        .glass-btn { 
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.05); 
            transition: all 0.2s ease; cursor: pointer; 
        }
        .glass-btn:active { transform: scale(0.95); }
        .glass-btn.active-red { background: rgba(239, 68, 68, 0.2); border-color: rgba(239, 68, 68, 0.5); color: #ef4444; }

        /* VIDEO & LAYOUT */
        #video-layer { position: fixed; inset: 0; background: #000; display: flex; justify-content: center; align-items: center; }
        iframe { width: 100% !important; height: 100% !important; border: none; }
        
        /* CLICK OVERLAY (Блокировщик для синхронизации) */
        #click-overlay { position: absolute; inset: 0; cursor: default; display: block; }
        /* Когда режим Native включен, оверлей скрывается, и клики идут в iframe */
        .native-mode #click-overlay { display: none !important; pointer-events: none !important; }
        .native-mode iframe { pointer-events: auto !important; }

        /* UI LAYER */
        #ui-layer { 
            position: fixed; inset: 0; 
            pointer-events: none; /* ВАЖНО: пропускаем клики сквозь пустые места */
            display: flex; flex-direction: column; justify-content: space-between; 
            padding: env(safe-area-inset-top) 16px env(safe-area-inset-bottom) 16px;
            transition: opacity 0.3s ease;
        }
        /* Включаем клики только на самих кнопках и панелях */
        #top-bar, #bottom-bar, #sidebar, .pointer-auto { pointer-events: auto !important; }

        /* SIDEBAR (CHAT) */
        #sidebar {
            position: fixed; left: 0; right: 0; bottom: 0; 
            height: 70vh; border-radius: 24px 24px 0 0;
            transform: translateY(110%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            display: flex; flex-direction: column; z-index: 60;
            visibility: hidden; /* Скрываем полностью, чтобы не перекрывал экран */
        }
        #sidebar.active { transform: translateY(0); visibility: visible; }
        
        @media (min-width: 768px) {
            #sidebar {
                left: auto; right: 20px; top: 80px; bottom: 100px; width: 320px; height: auto;
                border-radius: 24px; transform: translateX(120%);
            }
            #sidebar.active { transform: translateX(0); }
        }

        /* CONTROLS */
        .seek-slider { -webkit-appearance: none; width: 100%; height: 6px; background: rgba(255,255,255,0.15); border-radius: 4px; outline: none; }
        .seek-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%; background: #fff; box-shadow: 0 0 10px rgba(255,255,255,0.5); }

        /* TOASTS */
        #notification-area {
            position: fixed; top: 100px; left: 0; right: 0; z-index: 9999; 
            pointer-events: none; display: flex; flex-direction: column; align-items: center; gap: 8px;
        }
        .toast {
            background: rgba(20, 20, 20, 0.95); border-left: 4px solid #fbbf24; 
            padding: 12px 20px; border-radius: 12px; color: #fff; font-size: 13px;
            opacity: 0; transform: translateY(-10px); transition: 0.3s;
            max-width: 90%; text-align: center;
        }
        .toast.show { opacity: 1; transform: translateY(0); }

        /* UTILS */
        .force-hidden { display: none !important; }
        
        /* Скрываем элементы при Native Mode, но оставляем нижнюю панель (прозрачной), чтобы доступна была шестеренка */
        .native-mode #top-bar { opacity: 0; pointer-events: none !important; }
        .native-mode #timeline-container { opacity: 0; pointer-events: none !important; }
        .native-mode #bottom-bg { background: transparent !important; border: none !important; box-shadow: none !important; backdrop-filter: none !important; }
        .native-mode .hide-in-native { opacity: 0; pointer-events: none !important; }
    </style>
</head>
<body onclick="unlockAudio()">

    <div id="notification-area"></div>

    <div id="screen-auth" class="fixed inset-0 layer-modal flex items-center justify-center bg-[#050505] p-4">
        <div class="glass-panel p-8 rounded-[32px] max-w-sm w-full text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500"></div>
            <h1 class="text-4xl font-extrabold mb-2">Co-Watch</h1>
            <p class="text-gray-400 mb-8 text-sm font-mono uppercase">Batya Edition</p>
            <button id="btn-google-login" class="w-full bg-white text-black font-bold py-4 rounded-xl mb-3 hover:bg-gray-200 transition">Войти через Google</button>
            <button id="btn-guest-login" class="w-full glass-btn py-4 rounded-xl text-sm font-semibold">Войти как Гость</button>
        </div>
    </div>

    <div id="screen-lobby" class="fixed inset-0 layer-ui flex items-center justify-center bg-[#050505] force-hidden pointer-events-auto overflow-y-auto">
        <div class="w-full max-w-5xl p-4 flex flex-col md:flex-row gap-6 min-h-[80vh]">
            <div class="w-full md:w-1/3 glass-panel rounded-3xl p-6 flex flex-col items-center justify-center shrink-0">
                <img id="lobby-avatar" class="w-24 h-24 rounded-full mb-4 border-4 border-white/10">
                <h2 class="text-xl font-bold mb-2 text-center"><span id="lobby-username">Guest</span></h2>
                <button id="btn-logout" class="text-xs text-red-400 border border-red-500/20 px-4 py-2 rounded-full">Выйти</button>
            </div>
            <div class="w-full md:w-2/3 glass-panel rounded-3xl p-6 flex flex-col justify-center space-y-6 shrink-0 relative">
                <h3 class="text-2xl font-bold">Кинозал</h3>
                <button id="btn-create-room" class="w-full bg-white text-black py-4 rounded-2xl font-bold text-lg hover:scale-[1.01] transition">
                    <i class="fa-solid fa-plus mr-2"></i> Создать комнату
                </button>
                <div class="flex flex-col md:flex-row gap-3 pt-4 border-t border-white/10">
                    <input id="input-room-id" placeholder="ID комнаты..." class="w-full bg-black/30 border border-white/10 rounded-2xl px-6 py-4 text-lg font-mono text-center uppercase">
                    <button id="btn-join-room" class="glass-btn w-full md:w-auto px-8 py-4 rounded-2xl font-bold text-lg">GO</button>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-app" class="fixed inset-0 bg-black force-hidden">
        
        <div id="video-layer" class="layer-video">
            <div id="player-placeholder" class="flex flex-col items-center justify-center p-4 text-center">
                <i class="fa-solid fa-film text-4xl text-white/30 mb-4 animate-pulse"></i>
                <p class="text-white/30 font-mono text-xs">ЖДЕМ ВИДЕО ОТ БАТИ</p>
            </div>
            <div id="player-yt" class="force-hidden w-full h-full absolute inset-0"></div>
            <div id="player-vk-container" class="force-hidden w-full h-full absolute inset-0"></div>
            <video id="player-stream" class="force-hidden w-full h-full absolute inset-0 object-contain" autoplay playsinline></video>
            
            <div id="click-overlay" class="layer-overlay"></div>
        </div>

        <div id="ui-layer" class="layer-ui">
            
            <div id="top-bar" class="flex justify-between items-center transition-all duration-300">
                <div class="glass-panel px-3 py-2 rounded-full flex gap-3 items-center" id="copy-room-id">
                    <div class="w-8 h-8 bg-green-500/20 rounded-full flex items-center justify-center text-green-400 shrink-0">
                        <i class="fa-solid fa-link text-xs"></i>
                    </div>
                    <span id="display-room-id" class="font-mono font-bold text-sm tracking-wider">...</span>
                </div>

                <div class="flex gap-2">
                     <button onclick="toggleMobileUrlModal()" class="glass-panel w-10 h-10 rounded-full flex items-center justify-center text-white md:hidden">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                    <button id="btn-toggle-sidebar" class="glass-panel w-10 h-10 rounded-full flex items-center justify-center text-white relative">
                        <i class="fa-solid fa-comment-dots"></i>
                        <span id="badge-users" class="absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 rounded-full hidden"></span>
                    </button>
                    <button id="btn-leave-room" class="glass-panel w-10 h-10 rounded-full flex items-center justify-center text-red-400">
                        <i class="fa-solid fa-right-from-bracket"></i>
                    </button>
                </div>
            </div>

            <div id="desktop-url-bar" class="hidden md:flex absolute top-4 left-1/2 -translate-x-1/2 glass-panel p-1.5 rounded-full gap-2 w-[400px] pointer-auto">
                <input id="input-video-url" placeholder="YouTube / VK / Link..." class="bg-transparent flex-1 px-4 outline-none text-sm">
                <button id="btn-load-video" class="w-8 h-8 bg-white text-black rounded-full flex items-center justify-center"><i class="fa-solid fa-play text-xs ml-0.5"></i></button>
            </div>

            <div id="sidebar" class="glass-panel shadow-2xl pb-safe pointer-auto">
                <div class="w-full flex justify-center pt-3 pb-1 md:hidden" onclick="get('sidebar').classList.remove('active')">
                    <div class="w-12 h-1.5 bg-white/20 rounded-full"></div>
                </div>
                <div class="flex border-b border-white/5 shrink-0">
                    <button id="tab-chat" class="flex-1 py-4 text-xs font-bold uppercase bg-white/5">Чат</button>
                    <button id="tab-users" class="flex-1 py-4 text-xs font-bold uppercase text-white/40">Люди</button>
                </div>
                <div id="view-chat" class="flex-1 flex flex-col min-h-0 relative">
                    <div id="chat-messages" class="flex-1 overflow-y-auto p-4 flex flex-col gap-2"></div>
                    <div class="p-3 border-t border-white/5 bg-black/40">
                        <form id="form-chat" class="flex gap-2">
                            <input id="input-chat" class="flex-1 bg-white/10 rounded-xl px-4 py-3 text-sm text-white outline-none" placeholder="Сообщение..." autocomplete="off">
                            <button type="submit" class="w-11 h-11 bg-white text-black rounded-xl"><i class="fa-solid fa-paper-plane"></i></button>
                        </form>
                    </div>
                </div>
                <div id="view-users" class="flex-1 overflow-y-auto p-2 hidden">
                    <div id="list-users" class="flex flex-col gap-1"></div>
                </div>
            </div>

            <div class="flex flex-col gap-3 w-full max-w-2xl mx-auto pb-2 md:pb-6 transition-all duration-300">
                
                <div id="timeline-container" class="glass-panel px-4 py-3 rounded-2xl flex items-center gap-3">
                     <button id="btn-play-pause" class="w-8 h-8 flex items-center justify-center text-white" onclick="togglePlay()">
                         <i class="fa-solid fa-play"></i>
                     </button>
                     <span id="time-current" class="text-xs font-mono text-white/50 w-8 text-right">0:00</span>
                     <input type="range" id="seek-bar" class="seek-slider flex-1" min="0" max="100" value="0">
                     <span id="time-duration" class="text-xs font-mono text-white/50 w-8">0:00</span>
                </div>
                
                <div id="bottom-bg" class="glass-panel p-2 rounded-2xl flex justify-between items-center overflow-x-auto">
                    <button id="btn-toggle-voice" class="glass-btn w-12 h-12 rounded-xl flex items-center justify-center text-xl text-white/30 shrink-0 hide-in-native"><i class="fa-solid fa-microphone-slash"></i></button>
                    
                    <button id="btn-guest-control" class="glass-btn w-12 h-12 rounded-xl flex items-center justify-center text-xl text-white/30 shrink-0 hidden hide-in-native" title="Разрешить управление гостям" onclick="toggleGuestControl()">
                        <i class="fa-solid fa-lock"></i>
                    </button>

                    <div class="flex flex-col items-center px-4 shrink-0 hide-in-native">
                        <span class="text-[9px] text-white/30 uppercase font-bold">Status</span>
                        <div class="flex items-center gap-2">
                            <div id="status-dot" class="w-2 h-2 bg-green-500 rounded-full shadow-[0_0_10px_#22c55e]"></div>
                            <span id="status-text" class="text-xs font-bold text-green-400">READY</span>
                        </div>
                    </div>

                    <button id="btn-native" class="glass-btn w-12 h-12 rounded-xl flex items-center justify-center text-xl text-white/50 hover:text-white shrink-0 transition-colors" onclick="toggleNativeMode()" title="Режим Native (Скрыть UI)">
                        <i class="fa-solid fa-gear"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="mobile-url-modal" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-end justify-center p-4 force-hidden">
        <div class="glass-panel w-full max-w-lg p-5 rounded-2xl mb-4 pointer-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">Поставить видео</h3>
                <button onclick="toggleMobileUrlModal()" class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center"><i class="fa-solid fa-times"></i></button>
            </div>
            <input id="input-video-url-mobile" placeholder="Ссылка (YouTube / VK)..." class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-white mb-3 outline-none">
            <button id="btn-load-video-mobile" class="w-full bg-white text-black font-bold py-3 rounded-xl">Включить</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInAnonymously, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, serverTimestamp, addDoc, query, orderBy, limit, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBrm8hgy9LGFFL_7CdlnR6jxyolqy94AQA", authDomain: "upbeat-orb-479013-p8.firebaseapp.com", projectId: "upbeat-orb-479013-p8", storageBucket: "upbeat-orb-479013-p8.firebasestorage.app", messagingSenderId: "547138498300", appId: "1:547138498300:web:a03c11d6aafd5f027cf179" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const APP_ID = 'cw-admin-ux-final-v3'; // Increased version to clear cache

        const get = (id) => document.getElementById(id);
        const formatTime = (s) => { const m=Math.floor(s/60), sec=Math.floor(s%60); return `${m}:${sec<10?'0':''}${sec}`; };
        window.unlockAudio = () => { const a = new (window.AudioContext || window.webkitAudioContext)(); if(a.state==='suspended') a.resume(); };

        let currentRoomId = null;
        let currentUser = null;
        let myRole = 'viewer';
        let allowGuests = false; // New flag for guest control
        let isNativeMode = false;
        
        // --- UX HELPERS ---
        window.showNotification = (text) => {
            const area = get('notification-area');
            const toast = document.createElement('div');
            toast.className = 'toast'; toast.innerHTML = text;
            area.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('show'));
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
        };

        window.toggleMobileUrlModal = () => {
            get('mobile-url-modal').classList.toggle('force-hidden');
        };

        // --- AUTH ---
        onAuthStateChanged(auth, u => {
            if(u) {
                get('lobby-username').textContent = u.displayName || 'Guest';
                get('lobby-avatar').src = u.photoURL || `https://api.dicebear.com/7.x/adventurer/svg?seed=${u.uid}`;
                get('screen-auth').classList.add('force-hidden');
                get('screen-lobby').classList.remove('force-hidden');
            } else {
                get('screen-auth').classList.remove('force-hidden');
                get('screen-lobby').classList.add('force-hidden');
                get('screen-app').classList.add('force-hidden');
            }
        });

        get('btn-google-login').onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
        get('btn-guest-login').onclick = () => signInAnonymously(auth).then(c => updateProfile(c.user, { displayName: `Watcher ${Math.floor(Math.random()*100)}` }));
        get('btn-logout').onclick = () => signOut(auth);

        // --- ROOM LOGIC ---
        get('btn-create-room').onclick = () => joinRoom(Math.random().toString(36).substring(2,7).toUpperCase(), true);
        get('btn-join-room').onclick = () => { const id = get('input-room-id').value.trim().toUpperCase(); if(id) joinRoom(id); };
        
        get('copy-room-id').onclick = () => {
             navigator.clipboard.writeText(currentRoomId);
             showNotification("ID скопирован");
        };

        get('btn-leave-room').onclick = async () => {
             window.location.reload(); // Simplest way to clean up cleanly
        };

        async function joinRoom(id, isCreator = false) {
            currentRoomId = id; currentUser = auth.currentUser;
            get('display-room-id').textContent = id;
            
            const userRef = doc(db, 'artifacts', APP_ID, 'rooms', id, 'presence', currentUser.uid);
            await setDoc(userRef, {
                uid: currentUser.uid, displayName: currentUser.displayName, photoURL: currentUser.photoURL || `https://api.dicebear.com/7.x/adventurer/svg?seed=${currentUser.uid}`,
                role: isCreator ? 'admin' : 'viewer', joinedAt: serverTimestamp(), lastActive: serverTimestamp(), mutedByAdmin: false
            });

            // Room State Sync
            onSnapshot(doc(db, 'artifacts', APP_ID, 'rooms', id), s => { 
                if(s.exists()) {
                    const d = s.data();
                    syncState(d); 
                    // Sync Guest Control Permission
                    if (d.allowGuests !== undefined) {
                        allowGuests = d.allowGuests;
                        updateGuestControlUI();
                    }
                }
            });

            // Chat Sync
            onSnapshot(query(collection(db, 'artifacts', APP_ID, 'rooms', id, 'messages'), orderBy('createdAt', 'asc'), limit(50)), s => {
                const div = get('chat-messages');
                s.docChanges().forEach(c => {
                    if (c.type === 'added') {
                        const m = c.doc.data();
                        const el = document.createElement('div');
                        el.className = `chat-msg flex flex-col ${m.uid === currentUser.uid ? 'items-end' : 'items-start'}`;
                        el.innerHTML = `<span class="text-[10px] text-white/50 mb-0.5">${m.user}</span><span class="${m.uid === currentUser.uid ? 'bg-blue-500/20' : 'bg-white/10'} p-2 rounded-xl text-sm">${m.text}</span>`;
                        div.appendChild(el);
                        div.scrollTop = div.scrollHeight;
                        if(m.uid !== currentUser.uid && !get('sidebar').classList.contains('active')) showNotification(`<b>${m.user}:</b> ${m.text}`);
                    }
                });
            });

            // Users & Admin Election
            onSnapshot(collection(db, 'artifacts', APP_ID, 'rooms', id, 'presence'), s => {
                const list = get('list-users'); list.innerHTML = '';
                let users = []; let adminExists = false;
                s.forEach(d => {
                    const u = d.data(); users.push(u);
                    if (u.role === 'admin') adminExists = true;
                    if (u.uid === currentUser.uid) {
                        myRole = u.role;
                        updateAdminUI(); // Show/Hide Admin Controls
                    }
                });

                if (!adminExists && users.length > 0) {
                    users.sort((a, b) => (a.joinedAt?.seconds || 0) - (b.joinedAt?.seconds || 0));
                    if (users[0].uid === currentUser.uid) {
                        updateDoc(userRef, { role: 'admin' });
                        showNotification("ТЫ ТЕПЕРЬ БАТЯ (АДМИН)");
                    }
                }

                users.forEach(u => {
                    const el = document.createElement('div');
                    el.className = "flex justify-between items-center p-2 hover:bg-white/5 rounded-xl";
                    el.innerHTML = `
                        <div class="flex items-center gap-3">
                            <img src="${u.photoURL}" class="w-8 h-8 rounded-full">
                            <div><div class="text-xs font-bold">${u.displayName} ${u.role==='admin'?'<i class="fa-solid fa-crown text-yellow-400"></i>':''}</div></div>
                        </div>
                        ${myRole === 'admin' && u.uid !== currentUser.uid ? 
                            `<button onclick="toggleMute('${u.uid}', ${!u.mutedByAdmin})" class="w-8 h-8 bg-white/5 rounded-full"><i class="fa-solid ${u.mutedByAdmin ? 'fa-microphone-slash text-red-400' : 'fa-microphone'}"></i></button>` : ''}
                    `;
                    list.appendChild(el);
                });
                if(users.length>0) get('badge-users').classList.remove('hidden');
            });

            get('screen-lobby').classList.add('force-hidden');
            get('screen-app').classList.remove('force-hidden');
            setInterval(() => setDoc(userRef, { lastActive: serverTimestamp() }, { merge: true }), 30000);
        }

        // --- NEW: ADMIN & GUEST CONTROL LOGIC ---
        function updateAdminUI() {
            if (myRole === 'admin') {
                get('btn-guest-control').classList.remove('hidden');
                updateGuestControlUI();
            } else {
                get('btn-guest-control').classList.add('hidden');
            }
        }

        window.toggleGuestControl = () => {
            if (myRole !== 'admin') return;
            const newState = !allowGuests;
            setDoc(doc(db, 'artifacts', APP_ID, 'rooms', currentRoomId), { allowGuests: newState }, { merge: true });
        };

        function updateGuestControlUI() {
            const btn = get('btn-guest-control');
            if (allowGuests) {
                btn.innerHTML = '<i class="fa-solid fa-lock-open text-green-400"></i>';
                btn.classList.add('bg-green-500/10');
            } else {
                btn.innerHTML = '<i class="fa-solid fa-lock text-red-400"></i>';
                btn.classList.remove('bg-green-500/10');
            }
        }

        function canIControl() {
            if (myRole === 'admin') return true;
            if (allowGuests) return true;
            showNotification("<i class='fa-solid fa-lock'></i> Управление только у Бати");
            return false;
        }

        // --- UI INTERACTION ---
        get('btn-toggle-sidebar').onclick = () => get('sidebar').classList.toggle('active');
        get('form-chat').onsubmit = (e) => {
            e.preventDefault(); const t = get('input-chat').value.trim();
            if(t) addDoc(collection(db, 'artifacts', APP_ID, 'rooms', currentRoomId, 'messages'), { text: t, user: currentUser.displayName, uid: currentUser.uid, createdAt: serverTimestamp() });
            get('input-chat').value = '';
        };

        window.toggleMute = (uid, val) => updateDoc(doc(db, 'artifacts', APP_ID, 'rooms', currentRoomId, 'presence', uid), { mutedByAdmin: val });

        // --- NATIVE MODE ---
        window.toggleNativeMode = () => {
            isNativeMode = !isNativeMode;
            const btn = get('btn-native');
            const body = document.body;
            
            if (isNativeMode) {
                body.classList.add('native-mode');
                btn.classList.add('active-red');
                showNotification("Режим Native: UI скрыт, клики работают");
            } else {
                body.classList.remove('native-mode');
                btn.classList.remove('active-red');
                showNotification("Режим UI: Синхронизация");
            }
        };

        // --- VIDEO PLAYER LOGIC ---
        let activeProvider = 'none';
        let ytPlayer = null;

        get('btn-load-video').onclick = () => loadVideo(get('input-video-url').value);
        get('btn-load-video-mobile').onclick = () => { loadVideo(get('input-video-url-mobile').value); toggleMobileUrlModal(); };

        function loadVideo(url) {
            if (!canIControl()) return;
            if(!url) return;
            let provider = 'yt', videoId = '';
            const vkMatch = url.match(/video(-?\d+)_(\d+)/);
            const ytMatch = url.match(/(?:v=|\/)([\w-]{11})/);

            if (vkMatch) { provider = 'vk'; videoId = `https://vk.com/video_ext.php?oid=${vkMatch[1]}&id=${vkMatch[2]}&hd=2&autoplay=1`; }
            else if (ytMatch) { provider = 'yt'; videoId = ytMatch[1]; }

            setDoc(doc(db, 'artifacts', APP_ID, 'rooms', currentRoomId), { provider, videoId, status: 'playing', timestamp: 0 }, { merge: true });
        }

        function syncState(d) {
            if (d.videoId) get('player-placeholder').style.display = 'none';
            
            if (d.provider !== activeProvider) {
                activeProvider = d.provider;
                get('player-yt').classList.add('force-hidden');
                get('player-vk-container').classList.add('force-hidden');
                
                if (d.provider === 'yt') get('player-yt').classList.remove('force-hidden');
                if (d.provider === 'vk') {
                     get('player-vk-container').classList.remove('force-hidden');
                     get('player-vk-container').innerHTML = `<iframe src="${d.videoId}" allow="autoplay; fullscreen" frameborder="0"></iframe>`;
                }
            }

            if (d.provider === 'yt' && ytPlayer && ytPlayer.loadVideoById) {
                try {
                    const diff = Math.abs(ytPlayer.getCurrentTime() - d.timestamp);
                    if(ytPlayer.getVideoData().video_id !== d.videoId) ytPlayer.loadVideoById(d.videoId);
                    
                    // Only apply state if NOT in native mode (to prevent fighting with user input)
                    if (!isNativeMode) {
                        if(d.status === 'playing') ytPlayer.playVideo(); else ytPlayer.pauseVideo();
                        if(diff > 2) ytPlayer.seekTo(d.timestamp);
                    }
                    
                    get('btn-play-pause').innerHTML = d.status === 'playing' ? '<i class="fa-solid fa-pause"></i>' : '<i class="fa-solid fa-play"></i>';
                    get('status-text').innerText = d.status === 'playing' ? "PLAYING" : "PAUSED";
                } catch(e) {}
            }
        }

        // --- YOUTUBE API ---
        if(!window.YT) { const t = document.createElement('script'); t.src = "https://www.youtube.com/iframe_api"; document.body.appendChild(t); }
        window.onYouTubeIframeAPIReady = () => {
            ytPlayer = new YT.Player('player-yt', {
                height: '100%', width: '100%',
                playerVars: { 'controls': 0, 'rel': 0, 'origin': window.location.origin, 'disablekb': 1 },
                events: {
                    'onStateChange': (e) => {
                        // If Native mode is ON, we don't sync back to DB to avoid loops, OR we trust the user fully
                        if (!currentRoomId || !canIControl()) return;
                        if (e.data === 1 || e.data === 2) {
                             // Optional: Sync back even in native mode if you are admin
                             setDoc(doc(db, 'artifacts', APP_ID, 'rooms', currentRoomId), { status: e.data === 1 ? 'playing' : 'paused', timestamp: ytPlayer.getCurrentTime() }, { merge: true });
                        }
                    }
                }
            });
            setInterval(() => {
                if(ytPlayer && ytPlayer.getCurrentTime) {
                    const t = ytPlayer.getCurrentTime();
                    get('time-current').innerText = formatTime(t);
                    get('seek-bar').value = (t / ytPlayer.getDuration()) * 100 || 0;
                }
            }, 1000);
        };

        window.togglePlay = () => {
            if (!canIControl()) return;
            if (activeProvider === 'yt' && ytPlayer) {
                const s = ytPlayer.getPlayerState();
                setDoc(doc(db, 'artifacts', APP_ID, 'rooms', currentRoomId), { status: s === 1 ? 'paused' : 'playing', timestamp: ytPlayer.getCurrentTime() }, { merge: true });
            }
        };

        get('seek-bar').oninput = (e) => {
             if (!canIControl()) return;
             if (activeProvider === 'yt' && ytPlayer) {
                 const t = (e.target.value / 100) * ytPlayer.getDuration();
                 ytPlayer.seekTo(t);
                 setDoc(doc(db, 'artifacts', APP_ID, 'rooms', currentRoomId), { timestamp: t }, { merge: true });
             }
        };
    </script>
</body>
</html>
